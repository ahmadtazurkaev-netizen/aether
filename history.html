<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>–≠—Ñ–∏—Ä</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@600;700&family=IM+Fell+English:ital@0;1&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

<style>
:root{
  /* ===== –¢–Å–ú–ù–´–ô (–ü–û –£–ú–û–õ–ß–ê–ù–ò–Æ) ===== */
  --bg:#0c0805;
  --bg2:#120c07;
  --panel:#15100b;
  --card:#1c140e;
  --card2:#23170f;
  --text:#f3e6cf;
  --muted:#c7b08a;
  --dim:#9a8464;
  --accent:#e9cf67;
  --accent2:#caa53b;
  --border:#3a2b1b;
  --glow: rgba(233,207,103,.45);
  --danger:#b23a3a;
  --ok:#2f8a55;

  --tab-bg: rgba(255,255,255,.03);
  --tab-active: linear-gradient(180deg,#e9cf67,#caa53b);
  --tab-shadow: 0 0 24px rgba(233,207,103,.35);

  --shadow: 0 16px 40px rgba(0,0,0,.45);
  --shadow2: 0 10px 24px rgba(0,0,0,.35);
  --radius:18px;

  --fontTitle: "Cinzel", serif;
  --fontLore: "IM Fell English", serif;
  --fontUI: "Inter", system-ui, -apple-system, Segoe UI, sans-serif;

  --fzBase: 18px;
  --fzSmall: 14px;
  --fzH1: 46px;
  --fzH2: 30px;
  --fzH3: 20px;
}

/* ===== –°–í–ï–¢–õ–ê–Ø –¢–ï–ú–ê ===== */
body.light{
  --bg:#f4efe7;
  --bg2:#ffffff;
  --panel:#ffffff;
  --card:#faf7f2;
  --card2:#ffffff;
  --text:#2b1d12;
  --muted:#6a4c32;
  --dim:#7c5b3d;
  --accent:#b08a2e;
  --accent2:#8f6a1f;
  --border:#e1d4bc;
  --glow: rgba(176,138,46,.35);
  --tab-bg:#ffffff;
  --tab-active: linear-gradient(180deg,#b08a2e,#8f6a1f);
}

/* ===== –§–ò–û–õ–ï–¢–û–í–ê–Ø (–ú–ê–ì–ò–Ø) ===== */
body.violet{
  --bg:#120816;
  --bg2:#1a0d22;
  --panel:#1b1026;
  --card:#231330;
  --card2:#2a163c;
  --text:#f3dcff;
  --muted:#c8a9dd;
  --dim:#a786bf;
  --accent:#b77cff;
  --accent2:#8b4fd6;
  --border:#3c2057;
  --glow: rgba(183,124,255,.45);
  --tab-bg: rgba(183,124,255,.08);
  --tab-active: linear-gradient(180deg,#b77cff,#8b4fd6);
  --tab-shadow: 0 0 26px rgba(183,124,255,.35);
}

*{ box-sizing:border-box; margin:0; padding:0; }
body{
  font-family: var(--fontUI);
  font-size: var(--fzBase);
  color: var(--text);
  background:
    radial-gradient(1200px 700px at 20% -10%, rgba(233,207,103,.12), transparent 55%),
    radial-gradient(900px 520px at 85% 0%, rgba(233,207,103,.08), transparent 55%),
    radial-gradient(1100px 700px at 50% 120%, rgba(110,70,30,.22), transparent 60%),
    linear-gradient(180deg, var(--bg2), var(--bg));
  min-height:100vh;
}

header{
  text-align:center;
  padding:26px 14px 18px;
  border-bottom:1px solid rgba(233,207,103,.14);
  background: linear-gradient(180deg, rgba(0,0,0,.55), rgba(0,0,0,.12));
}
header h1{
  font-family: var(--fontTitle);
  font-size: var(--fzH1);
  letter-spacing: 2px;
  color: var(--accent);
  text-shadow: 0 10px 30px rgba(0,0,0,.55);
}
header .sub{
  margin-top:8px;
  font-family: var(--fontLore);
  font-size: 20px;
  color: rgba(243,230,207,.92);
  opacity:.9;
}

nav{
  position:sticky;
  top:0;
  z-index:50;
  padding:12px 12px;
  background: rgba(10,7,4,.86);
  backdrop-filter: blur(10px);
  border-bottom:1px solid rgba(233,207,103,.12);
}
.navRow{
  max-width: 1600px;
  margin:0 auto;
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  justify-content:center;
  align-items:center;
}
nav button{
  background: var(--tab-bg);
  border:1px solid var(--border);
  color: var(--text);
  padding:12px 18px;
  border-radius:16px;
  cursor:pointer;
  font-family: var(--fontTitle);
  font-weight:700;
  letter-spacing:.6px;
  position:relative;
  transition: all .18s ease;
  box-shadow: inset 0 0 0 rgba(0,0,0,0);
}
nav button:hover{
  transform: translateY(-2px);
  box-shadow: 0 6px 18px rgba(0,0,0,.35);
}
nav button.active{
  background: var(--tab-active);
  color:#0b0704;
  box-shadow: var(--tab-shadow);
  border-color: transparent;
}
nav button.active::after{
  content:"";
  position:absolute;
  inset:-2px;
  border-radius:18px;
  box-shadow: 0 0 22px var(--glow);
  pointer-events:none;
}
nav .right{
  display:flex;
  gap:10px;
  margin-left:auto;
  flex-wrap:wrap;
  justify-content:center;
}

main{
  max-width: 1600px;
  margin: 0 auto;
  padding: 18px 12px 50px;
}
section{ display:none; animation:fade .18s ease; }
section.active{ display:block; }
@keyframes fade{ from{opacity:0; transform:translateY(8px);} to{opacity:1; transform:none;} }

.row{ display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
.spacer{ flex:1; }

.card{
  background: linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.01));
  border: 1px solid rgba(233,207,103,.14);
  border-radius: var(--radius);
  box-shadow: var(--shadow2);
  padding: 16px;
}
.card.big{ padding: 18px; }
.paper{
  background:
    radial-gradient(900px 480px at 20% 0%, rgba(233,207,103,.06), transparent 55%),
    radial-gradient(900px 480px at 90% 0%, rgba(233,207,103,.05), transparent 55%),
    linear-gradient(180deg, rgba(255,255,255,.02), rgba(0,0,0,.06));
}

.grid{
  display:grid;
  grid-template-columns: repeat(auto-fill, minmax(360px, 1fr));
  gap: 14px;
}
@media(max-width: 860px){ .grid{ grid-template-columns: 1fr; } }

h2{
  font-family: var(--fontTitle);
  font-size: var(--fzH2);
  color: var(--accent);
  margin-bottom: 10px;
  letter-spacing: .6px;
}
h3{
  font-family: var(--fontTitle);
  font-size: var(--fzH3);
  color: var(--accent);
  margin-bottom: 8px;
}
.hint{
  font-family: var(--fontLore);
  font-size: 20px;
  color: rgba(243,230,207,.92);
  opacity: .85;
  line-height: 1.45;
}
.small{
  font-size: var(--fzSmall);
  color: var(--muted);
  opacity: .95;
}

label{
  display:block;
  margin: 10px 0 6px;
  color: rgba(233,207,103,.85);
  font-family: var(--fontTitle);
  font-size: 14px;
  letter-spacing:.4px;
}

input, textarea, select{
  width:100%;
  background: rgba(0,0,0,.36);
  color: var(--text);
  border: 1px solid rgba(233,207,103,.16);
  border-radius: 14px;
  padding: 12px 12px;
  font-size: 17px;
  outline:none;
  transition: box-shadow .12s ease, border-color .12s ease;
}
textarea{ min-height: 110px; resize: vertical; }
input:focus, textarea:focus, select:focus{
  border-color: rgba(233,207,103,.42);
  box-shadow: 0 0 0 4px rgba(233,207,103,.12);
}

.btn{
  border:none;
  background: var(--tab-active);
  color: #0b0704;
  padding: 10px 14px;
  border-radius: 14px;
  cursor:pointer;
  font-family: var(--fontTitle);
  font-weight: 800;
  font-size: 14px;
  letter-spacing:.4px;
  transition: transform .12s ease, filter .12s ease;
}
.btn:hover{ transform: translateY(-1px); filter: brightness(1.02); }
.btn:active{ transform: translateY(0); }
.btn.ghost{
  background: rgba(255,255,255,.02);
  color: var(--text);
  border: 1px solid rgba(233,207,103,.18);
}
.btn.danger{
  background: linear-gradient(180deg, rgba(178,58,58,.95), rgba(140,38,38,.92));
  color:#fff;
}
.btn.ok{
  background: linear-gradient(180deg, rgba(63,171,106,.95), rgba(47,138,85,.92));
  color:#07130c;
}
.btn.small{ padding: 8px 12px; border-radius: 12px; }

.pill{
  display:inline-flex;
  align-items:center;
  gap:8px;
  padding: 6px 10px;
  border-radius: 999px;
  border:1px solid rgba(233,207,103,.18);
  background: rgba(233,207,103,.06);
  color: rgba(233,207,103,.96);
  font-family: var(--fontTitle);
  font-weight: 800;
  font-size: 12.5px;
}
.hr{ height:1px; background: rgba(233,207,103,.12); margin: 14px 0; }

#saveDot{
  position:fixed;
  top:14px;
  right:14px;
  width:12px;
  height:12px;
  border-radius:50%;
  background: var(--ok);
  opacity:0;
  transition: opacity .25s ease;
  box-shadow: 0 0 0 4px rgba(47,138,85,.14);
  z-index:999;
}
#saveDot.show{ opacity:1; }
#errorBar{
  display:none;
  margin: 12px 0 0;
  padding: 12px 14px;
  border-radius: 14px;
  border: 1px solid rgba(255,120,120,.35);
  background: rgba(160,40,40,.18);
  color: rgba(255,210,210,.96);
}

/* MAP */
.mapLayout{
  display:grid;
  grid-template-columns: 1.2fr .8fr;
  gap: 14px;
  align-items:start;
}
@media(max-width: 1100px){ .mapLayout{ grid-template-columns: 1fr; } }
.mapFrame{
  position:relative;
  height: 76vh;
  border-radius: var(--radius);
  overflow:hidden;
  border:1px solid rgba(233,207,103,.18);
  background:
    radial-gradient(1200px 700px at 30% 0%, rgba(233,207,103,.10), transparent 60%),
    linear-gradient(180deg, rgba(0,0,0,.55), rgba(0,0,0,.45));
  box-shadow: var(--shadow);
}
.mapImg{
  position:absolute;
  inset:0;
  width:100%;
  height:100%;
  object-fit: contain;
  user-select:none;
  pointer-events:none; /* no accidental pan/zoom */
  -webkit-user-drag: none;
  transform-origin: center center;
}
.layer{ position:absolute; inset:0; }
.svgLayer{ position:absolute; inset:0; pointer-events:auto; }

.marker{
  position:absolute;
  transform: translate(-50%,-50%);
  width: 36px;
  height: 36px;
  border-radius: 999px;
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight:900;
  cursor:pointer;
  user-select:none;
  box-shadow: 0 12px 28px rgba(0,0,0,.45);
  border: 2px solid rgba(0,0,0,.35);
}
.marker.selected{ outline: 4px solid rgba(255,255,255,.18); }

.markerLabel{
  position:absolute;
  transform: translate(-50%, 10px);
  font-family: var(--fontTitle);
  font-weight:800;
  font-size: 14px;
  color: rgba(233,207,103,.98);
  text-shadow: 0 6px 18px rgba(0,0,0,.85);
  white-space:nowrap;
  pointer-events:none;
  opacity:.95;
}

.legendRow{
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  align-items:center;
}
.legendRow .pill{
  cursor:pointer;
  user-select:none;
}
.legendRow .pill.off{
  opacity:.35;
  filter:saturate(.4);
}

.timelineBar{
  height: 20px;
  border-radius: 999px;
  border:1px solid rgba(233,207,103,.16);
  background: rgba(233,207,103,.06);
  overflow:hidden;
  position:relative;
}
.timelineFill{
  position:absolute; left:0; top:0; bottom:0;
  background: linear-gradient(90deg, rgba(233,207,103,.15), rgba(233,207,103,.55));
}

.mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; font-size: 13px; color: var(--muted); }
</style>
</head>

<body>
<div id="saveDot"></div>

<header>
  <h1>–≠—Ñ–∏—Ä</h1>
  <div class="sub">–õ–∏—á–Ω—ã–π –∞—Ç–ª–∞—Å –º–∏—Ä–∞: –∫–∞—Ä—Ç–∞, —ç–ø–æ—Ö–∏, —Å–∏–ª—ã, —Ç–∞–π–Ω—ã –∏ —Ö—Ä–æ–Ω–∏–∫–∞</div>
</header>

<nav>
  <div class="navRow">
    <button data-tab="world" class="active">üåç –ú–∏—Ä</button>
    <button data-tab="map">üó∫ –ö–∞—Ä—Ç–∞</button>
    <button data-tab="timeline">‚è≥ –≠–ø–æ—Ö–∏</button>
    <button data-tab="factions">ü©∏ –§—Ä–∞–∫—Ü–∏–∏</button>
    <button data-tab="events">üìå –°–æ–±—ã—Ç–∏—è</button>
    <button data-tab="links">üîó –°–≤—è–∑–∏</button>
    <button data-tab="checkpoints">‚úÖ –ß–µ–∫–ø–æ–∏–Ω—Ç—ã</button>
    <button data-tab="journal">üìú –•—Ä–æ–Ω–∏–∫–∞</button>
    <button data-tab="secrets">üîÆ –¢–∞–π–Ω–æ–µ</button>

    <div class="right">
      <button id="themeDark" class="btn ghost small" title="–¢—ë–º–Ω—ã–π">üåë</button>
      <button id="themeLight" class="btn ghost small" title="–°–≤–µ—Ç–ª—ã–π">‚òÄÔ∏è</button>
      <button id="themeViolet" class="btn ghost small" title="–§–∏–æ–ª–µ—Ç–æ–≤—ã–π">üíú</button>

      <button id="exportBtn" class="btn ghost small">üíæ –≠–∫—Å–ø–æ—Ä—Ç</button>
      <button id="importBtn" class="btn ghost small">üì• –ò–º–ø–æ—Ä—Ç</button>
    </div>
  </div>
</nav>

<main>
  <div id="errorBar"><b>–û—à–∏–±–∫–∞:</b> <span id="errorText"></span></div>

  <!-- WORLD -->
  <section id="world" class="active">
    <div class="card big paper">
      <div class="row">
        <h2>–ú–∏—Ä –≠—Ñ–∏—Ä</h2>
        <div class="spacer"></div>
        <span class="pill">–æ—Å–Ω–æ–≤–∞</span>
      </div>
      <div class="hint" style="margin-bottom:10px;">
        –ö–æ—Ä–æ—Ç–∫–æ–µ, —Å–∏–ª—å–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –º–∏—Ä–∞. –ó–¥–µ—Å—å –∑–∞–¥–∞—ë—Ç—Å—è —Ç–æ–Ω: —Ü–µ–Ω–∞ –º–∞–≥–∏–∏, –¥—É—Ö —ç–ø–æ—Ö–∏, —Å—Ç—Ä–∞—Ö–∏ –∏ –Ω–∞–¥–µ–∂–¥—ã.
      </div>

      <label>–õ–æ–≥–ª–∞–π–Ω –º–∏—Ä–∞ (1‚Äì2 —Å—Ç—Ä–æ–∫–∏)</label>
      <input id="worldLogline" placeholder="–ù–∞–ø—Ä.: –≠—Ñ–∏—Ä ‚Äî –º–∏—Ä –∫–ª–∏–Ω–∫–æ–≤ –∏ –∫–ª—è—Ç–≤, –≥–¥–µ –º–∞–≥–∏—è –≤—Å–µ–≥–¥–∞ —Ç—Ä–µ–±—É–µ—Ç –ø–ª–∞—Ç—ã‚Ä¶">

      <label>–ó–∞–∫–æ–Ω—ã –º–∏—Ä–∞</label>
      <textarea id="worldRules" placeholder="–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –º–∞–≥–∏—è? —á—Ç–æ –∑–∞–ø—Ä–µ—â–µ–Ω–æ? —á—Ç–æ —Å–≤—è—Ç–æ?"></textarea>

      <label>–ì–ª–∞–≤–Ω—ã–µ —Ç–µ–º—ã (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)</label>
      <input id="worldThemes" placeholder="–º–∞–≥–∏—è, –≤–µ—Ä–∞, —É–ø–∞–¥–æ–∫, –≤–æ–π–Ω–∞‚Ä¶">

      <label>–¢–≤–æ—è –∞–≤—Ç–æ—Ä—Å–∫–∞—è –Ω–∏—Ç—å</label>
      <textarea id="worldNote" placeholder="–ß—Ç–æ —Ç—ã —Ö–æ—á–µ—à—å –ø—Ä–æ–∂–∏—Ç—å –≤ —ç—Ç–æ–π –∏—Å—Ç–æ—Ä–∏–∏?"></textarea>

      <div class="hr"></div>
      <div class="row">
        <button class="btn ok" id="worldSaveBtn">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <span class="small">–ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –≤—Å–µ–≥–¥–∞, –Ω–æ –∫–Ω–æ–ø–∫–∞ ‚Äî –∫–∞–∫ –ø–µ—á–∞—Ç—å –º–∞—Å—Ç–µ—Ä–∞.</span>
      </div>
    </div>
  </section>

  <!-- MAP -->
  <section id="map">
    <div class="mapLayout">
      <div class="card big paper">
        <div class="row">
          <h2>–ö–∞—Ä—Ç–∞ –≠—Ñ–∏—Ä–∞</h2>
          <div class="spacer"></div>
          <span class="pill" id="mapModePill">–†–µ–∂–∏–º: –û—Ç–º–µ—Ç–∫–∏</span>
        </div>

        <div class="hint" style="margin-bottom:10px;">
          <b>–°–ª—É—á–∞–π–Ω—ã–π –∑—É–º/–ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ –æ—Ç–∫–ª—é—á–µ–Ω—ã.</b> –ü–æ–¥–≥–æ–Ω—è–π –∫–∞—Ä—Ç—É —á–µ—Ä–µ–∑ –º–∞—Å—à—Ç–∞–± –∏ —Ä–µ–∂–∏–º <span class="mono">contain/cover</span>.
          –î–æ–±–∞–≤–ª—è–π –æ—Ç–º–µ—Ç–∫–∏, —Ä–µ–≥–∏–æ–Ω—ã –∏ —Å–≤—è–∑–∏. –í–∫–ª—é—á–∞–π —Å–ª–æ–∏ –∫–∞–∫ –ª–µ–≥–µ–Ω–¥—É –∫–∞—Ä—Ç—ã.
        </div>

        <div class="legendRow" style="margin:10px 0;">
          <span class="pill" id="layerPolitics">üèõ –ü–æ–ª–∏—Ç–∏–∫–∞</span>
          <span class="pill" id="layerMagic">‚ú® –ú–∞–≥–∏—è</span>
          <span class="pill" id="layerWar">‚öî –í–æ–π–Ω–∞</span>
          <span class="pill" id="layerSecrets">üîÆ –¢–∞–π–Ω—ã</span>
          <span class="pill" id="layerAll">üß≠ –í—Å—ë</span>
          <div class="spacer"></div>

          <label style="display:flex; gap:8px; align-items:center; margin:0; font-family:var(--fontUI); color:var(--muted);">
            <input type="checkbox" id="toggleLabels" style="width:18px; height:18px; margin:0;">
            –ü–æ–¥–ø–∏—Å–∏
          </label>
        </div>

        <div class="row" style="margin:10px 0;">
          <button class="btn" id="modeMarkers">üìç –û—Ç–º–µ—Ç–∫–∏</button>
          <button class="btn ghost" id="modeRegions">üó∫ –†–µ–≥–∏–æ–Ω—ã</button>
          <button class="btn ghost" id="modeLinks">üîó –°–≤—è–∑–∏</button>
          <button class="btn ghost" id="modeView">üîí –ü—Ä–æ—Å–º–æ—Ç—Ä</button>
          <div class="spacer"></div>
        </div>

        <div class="grid" style="grid-template-columns: 1fr 1fr;">
          <div class="card paper" style="margin:0;">
            <h3>–ö–∞—Ä—Ç–∞</h3>
            <label>–ó–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</label>
            <input type="file" id="mapUpload" accept="image/*">

            <div class="row">
              <div style="flex:1;">
                <label>–†–µ–∂–∏–º –ø–æ–¥–≥–æ–Ω–∫–∏</label>
                <select id="fitMode">
                  <option value="contain">contain (–≤–ª–µ–∑–∞–µ—Ç —Ü–µ–ª–∏–∫–æ–º)</option>
                  <option value="cover">cover (–±–µ–∑ —Ä–∞–º–æ–∫)</option>
                </select>
              </div>
              <div style="flex:1;">
                <label>–ú–∞—Å—à—Ç–∞–± –∫–∞—Ä—Ç—ã</label>
                <input id="mapScale" type="range" min="70" max="170" value="100">
                <div class="small">–¢–µ–∫—É—â–∏–π: <span id="mapScaleLabel">100%</span></div>
              </div>
            </div>

            <div class="row" style="margin-top:10px;">
              <button class="btn ghost small" id="clearMap">–£–±—Ä–∞—Ç—å –∫–∞—Ä—Ç—É</button>
              <button class="btn danger small" id="clearMapObjects">–°—Ç–µ—Ä–µ—Ç—å –æ—Ç–º–µ—Ç–∫–∏/—Ä–µ–≥–∏–æ–Ω—ã/–ª–∏–Ω–∏–∏</button>
            </div>
          </div>

          <div class="card paper" style="margin:0;">
            <h3>–°–æ–∑–¥–∞–Ω–∏–µ</h3>

            <div id="markerCreate">
              <label>–¢–∏–ø –æ—Ç–º–µ—Ç–∫–∏</label>
              <select id="markerType">
                <option value="city">üè∞ –ì–æ—Ä–æ–¥</option>
                <option value="village">üèò –î–µ—Ä–µ–≤–Ω—è</option>
                <option value="fort">üõ° –ö—Ä–µ–ø–æ—Å—Ç—å</option>
                <option value="tower">üóº –ë–∞—à–Ω—è</option>
                <option value="ruins">‚öî –†—É–∏–Ω—ã</option>
                <option value="dungeon">üï≥ –ü–æ–¥–∑–µ–º–µ–ª—å–µ</option>
                <option value="magic">‚ú® –ú–∞–≥–∏—á–µ—Å–∫–æ–µ –º–µ—Å—Ç–æ</option>
                <option value="port">‚öì –ü–æ—Ä—Ç</option>
                <option value="danger">‚ò† –û–ø–∞—Å–Ω–æ—Å—Ç—å</option>
              </select>

              <label>–°–ª–æ–π</label>
              <select id="markerLayer">
                <option value="politics">üèõ –ü–æ–ª–∏—Ç–∏–∫–∞</option>
                <option value="magic">‚ú® –ú–∞–≥–∏—è</option>
                <option value="war">‚öî –í–æ–π–Ω–∞</option>
                <option value="secrets">üîÆ –¢–∞–π–Ω—ã</option>
              </select>

              <label>–¶–≤–µ—Ç</label>
              <select id="markerColor">
                <option value="gold">–ó–æ–ª–æ—Ç–æ</option>
                <option value="white">–ë–µ–ª—ã–π</option>
                <option value="red">–ö—Ä–∞—Å–Ω—ã–π</option>
                <option value="blue">–°–∏–Ω–∏–π</option>
                <option value="green">–ó–µ–ª—ë–Ω—ã–π</option>
                <option value="purple">–§–∏–æ–ª–µ—Ç–æ–≤—ã–π</option>
              </select>

              <label>–ì–ª–∞–≤–∞ (—ç–ø–æ—Ö–∞/–∞–∫—Ç)</label>
              <input id="markerChapter" type="number" min="1" value="1">

              <label>–¢–µ–≥–∏ (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)</label>
              <input id="markerTags" placeholder="–º–∞–≥–∏—è, –≤–µ—Ä–∞, –≤–æ–π–Ω–∞‚Ä¶">
              <div class="small">–°–æ–≤–µ—Ç: —Ç–µ–≥–∏ –¥–æ–±–∞–≤—è—Ç—Å—è –≤ ¬´–¢–µ–º—ã¬ª –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.</div>
            </div>

            <div id="regionCreate" style="display:none;">
              <div class="hint">
                –†–µ–∂–∏–º —Ä–µ–≥–∏–æ–Ω–æ–≤: –∫–ª–∏–∫–∞–π –ø–æ –∫–∞—Ä—Ç–µ, —á—Ç–æ–±—ã —Å—Ç–∞–≤–∏—Ç—å –≤–µ—Ä—à–∏–Ω—ã –ø–æ–ª–∏–≥–æ–Ω–∞.
                –ú–∏–Ω–∏–º—É–º 3 —Ç–æ—á–∫–∏. –ó–∞—Ç–µ–º –Ω–∞–∂–º–∏ <b>–ó–∞–≤–µ—Ä—à–∏—Ç—å —Ä–µ–≥–∏–æ–Ω</b>.
              </div>
              <label>–°–ª–æ–π —Ä–µ–≥–∏–æ–Ω–∞</label>
              <select id="regionLayerSel">
                <option value="politics">üèõ –ü–æ–ª–∏—Ç–∏–∫–∞</option>
                <option value="magic">‚ú® –ú–∞–≥–∏—è</option>
                <option value="war">‚öî –í–æ–π–Ω–∞</option>
                <option value="secrets">üîÆ –¢–∞–π–Ω—ã</option>
              </select>
              <div class="row" style="margin-top:10px;">
                <button class="btn ok small" id="finishRegion">‚úÖ –ó–∞–≤–µ—Ä—à–∏—Ç—å —Ä–µ–≥–∏–æ–Ω</button>
                <button class="btn danger small" id="cancelRegion">‚úñ –û—Ç–º–µ–Ω–∞</button>
              </div>
            </div>

            <div id="linkCreate" style="display:none;">
              <div class="hint">
                –†–µ–∂–∏–º —Å–≤—è–∑–µ–π –Ω–∞ –∫–∞—Ä—Ç–µ: –∫–ª–∏–∫–Ω–∏ <b>–¥–≤–µ –æ—Ç–º–µ—Ç–∫–∏</b> ‚Äî –ø–æ—è–≤–∏—Ç—Å—è –ª–∏–Ω–∏—è.
              </div>
              <div class="pill" id="linkHintPill">–í—ã–±–µ—Ä–∏ –ø–µ—Ä–≤—É—é –æ—Ç–º–µ—Ç–∫—É‚Ä¶</div>
            </div>
          </div>
        </div>

        <div class="hr"></div>

        <div class="mapFrame" id="mapFrame">
          <img id="mapImg" class="mapImg" alt="–ö–∞—Ä—Ç–∞">
          <svg id="regionSvg" class="svgLayer"></svg>
          <svg id="linkSvg" class="svgLayer"></svg>
          <div id="markerLayerDiv" class="layer"></div>
          <div id="labelLayerDiv" class="layer"></div>
        </div>
      </div>

      <div class="card big paper">
        <div class="row">
          <h2>–í—ã–±—Ä–∞–Ω–Ω–æ–µ</h2>
          <div class="spacer"></div>
          <span class="pill" id="selectedPill">–Ω–∏—á–µ–≥–æ</span>
        </div>

        <div id="selectedEditor" class="small" style="margin-top:10px;">
          –í—ã–±–µ—Ä–∏ –æ—Ç–º–µ—Ç–∫—É/—Ä–µ–≥–∏–æ–Ω/–ª–∏–Ω–∏—é –Ω–∞ –∫–∞—Ä—Ç–µ, —á—Ç–æ–±—ã —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å.
        </div>

        <div class="hr"></div>

        <div class="row">
          <h3 style="margin:0;">–°–ø–∏—Å–∫–∏ –∫–∞—Ä—Ç—ã</h3>
          <div class="spacer"></div>
          <input id="mapSearch" placeholder="–ø–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é/—Ç–µ–≥–∞–º/–∑–∞–º–µ—Ç–∫–∞–º‚Ä¶" style="max-width:420px;">
        </div>

        <div class="hr"></div>
        <div id="mapLists"></div>
      </div>
    </div>
  </section>

  <!-- TIMELINE -->
  <section id="timeline">
    <div class="card big paper">
      <div class="row">
        <h2>–≠–ø–æ—Ö–∏ –≠—Ñ–∏—Ä–∞</h2>
        <div class="spacer"></div>
        <button class="btn" id="addEraBtn">‚ûï –ù–æ–≤–∞—è —ç–ø–æ—Ö–∞</button>
      </div>
      <div class="hint" style="margin-bottom:10px;">
        –í–∏–∑—É–∞–ª—å–Ω–∞—è —à–∫–∞–ª–∞ –≤—Ä–µ–º–µ–Ω–∏. –ü—Ä–∏–≤—è–∑—ã–≤–∞–π –æ–±—ä–µ–∫—Ç—ã –∫ –≥–ª–∞–≤–∞–º, —á—Ç–æ–±—ã –∏—Å—Ç–æ—Ä–∏—è –æ—â—É—â–∞–ª–∞—Å—å –∫–∞–∫ –ª–µ–≥–µ–Ω–¥–∞.
      </div>
      <div id="erasGrid" class="grid"></div>
    </div>
  </section>

  <!-- FACTIONS -->
  <section id="factions">
    <div class="card big paper">
      <div class="row">
        <h2>–§—Ä–∞–∫—Ü–∏–∏</h2>
        <div class="spacer"></div>
        <button class="btn" id="addFactionBtn">‚ûï –ù–æ–≤–∞—è —Ñ—Ä–∞–∫—Ü–∏—è</button>
      </div>
      <div class="hint" style="margin-bottom:10px;">
        –§—Ä–∞–∫—Ü–∏–∏ –º–æ–≥—É—Ç –≤–ª–∏—è—Ç—å –Ω–∞ —Ä–µ–≥–∏–æ–Ω—ã: –≤—ã–±–µ—Ä–∏ —Ñ—Ä–∞–∫—Ü–∏—é –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä–µ —Ä–µ–≥–∏–æ–Ω–∞ ‚Äî —Ä–µ–≥–∏–æ–Ω –ø–æ–¥—Å–≤–µ—Ç–∏—Ç—Å—è –µ—ë —Ü–≤–µ—Ç–æ–º.
      </div>
      <div id="factionsGrid" class="grid"></div>
    </div>
  </section>

  <!-- EVENTS -->
  <section id="events">
    <div class="card big paper">
      <div class="row">
        <h2>–°–æ–±—ã—Ç–∏—è</h2>
        <div class="spacer"></div>
        <button class="btn" id="addEventBtn">‚ûï –ù–æ–≤–æ–µ —Å–æ–±—ã—Ç–∏–µ</button>
      </div>
      <div class="hint" style="margin-bottom:10px;">
        –°–æ–±—ã—Ç–∏—è –¥–≤–∏–≥–∞—é—Ç –º–∏—Ä. –û–Ω–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–ø–∞–¥–∞—é—Ç –≤ —Ö—Ä–æ–Ω–∏–∫—É.
      </div>
      <div id="eventsGrid" class="grid"></div>
    </div>
  </section>

  <!-- LINKS -->
  <section id="links">
    <div class="card big paper">
      <div class="row">
        <h2>–°–≤—è–∑–∏ –º–∏—Ä–∞</h2>
        <div class="spacer"></div>
        <button class="btn" id="addLinkBtn">‚ûï –ù–æ–≤–∞—è —Å–≤—è–∑—å</button>
      </div>
      <div class="hint" style="margin-bottom:10px;">
        –°–≤—è–∑–∏: –ø–µ—Ä—Å–æ–Ω–∞–∂ ‚Üî –ª–æ–∫–∞—Ü–∏—è ‚Üî —Å–æ–±—ã—Ç–∏–µ ‚Üî —Ä–µ–≥–∏–æ–Ω ‚Üî —Ñ—Ä–∞–∫—Ü–∏—è.
      </div>
      <div id="linksGrid" class="grid"></div>
    </div>
  </section>

  <!-- CHECKPOINTS -->
  <section id="checkpoints">
    <div class="card big paper">
      <div class="row">
        <h2>–ß–µ–∫–ø–æ–∏–Ω—Ç—ã</h2>
        <div class="spacer"></div>
        <button class="btn ok" id="createCheckpointBtn">‚úÖ –°–æ–∑–¥–∞—Ç—å —á–µ–∫–ø–æ–∏–Ω—Ç</button>
      </div>
      <div class="hint" style="margin-bottom:10px;">
        –ß–µ–∫–ø–æ–∏–Ω—Ç ‚Äî —ç—Ç–æ ‚Äú—Å–Ω–∏–º–æ–∫ –º–∏—Ä–∞‚Äù. –ú–æ–∂–Ω–æ –æ—Ç–∫–∞—Ç–∏—Ç—å—Å—è –Ω–∞–∑–∞–¥, –µ—Å–ª–∏ —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç –ø–æ—à—ë–ª –Ω–µ —Ç—É–¥–∞.
        –°–æ–∑–¥–∞–Ω–∏–µ —á–µ–∫–ø–æ–∏–Ω—Ç–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–∏—à–µ—Ç –∑–∞–ø–∏—Å—å –≤ —Ö—Ä–æ–Ω–∏–∫—É.
      </div>

      <label>–ù–∞–∑–≤–∞–Ω–∏–µ —á–µ–∫–ø–æ–∏–Ω—Ç–∞</label>
      <input id="cpTitle" placeholder="–ù–∞–ø—Ä.: –ü–æ—Å–ª–µ –ø–∞–¥–µ–Ω–∏—è –¢—Ä–æ–Ω–Ω–æ–≥–æ –ì–æ—Ä–æ–¥–∞">

      <label>–û–ø–∏—Å–∞–Ω–∏–µ</label>
      <textarea id="cpNote" placeholder="–ß—Ç–æ –∏–º–µ–Ω–Ω–æ —Å–µ–π—á–∞—Å –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤ –º–∏—Ä–µ?"></textarea>

      <div class="hr"></div>
      <div id="checkpointsGrid" class="grid"></div>
    </div>
  </section>

  <!-- JOURNAL -->
  <section id="journal">
    <div class="card big paper">
      <div class="row">
        <h2>–•—Ä–æ–Ω–∏–∫–∞</h2>
        <div class="spacer"></div>
        <button class="btn" id="addJournalBtn">‚ûï –†—É—á–Ω–∞—è –∑–∞–ø–∏—Å—å</button>
      </div>
      <div class="hint" style="margin-bottom:10px;">
        –ó–¥–µ—Å—å —Ö—Ä–∞–Ω–∏—Ç—Å—è –ª–µ—Ç–æ–ø–∏—Å—å. –ß–∞—Å—Ç—å –∑–∞–ø–∏—Å–µ–π —Å–æ–∑–¥–∞—ë—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ (–∫–∞—Ä—Ç–∞, —Å–æ–±—ã—Ç–∏—è, —á–µ–∫–ø–æ–∏–Ω—Ç—ã).
      </div>
      <div id="journalGrid" class="grid"></div>
    </div>
  </section>

  <!-- SECRETS -->
  <section id="secrets">
    <div class="card big paper">
      <div class="row">
        <h2>–¢–∞–π–Ω–æ–µ</h2>
        <div class="spacer"></div>
        <span class="pill">—Å–∫—Ä—ã—Ç—ã–π —Å–ª–æ–π</span>
      </div>
      <div class="hint" style="margin-bottom:10px;">
        –í—Å–µ —Ç–∞–π–Ω—ã–µ –∑–∞–º–µ—Ç–∫–∏ –º–∏—Ä–∞ —Å–æ–±–∏—Ä–∞—é—Ç—Å—è –∑–¥–µ—Å—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.
      </div>
      <div id="secretsGrid" class="grid"></div>
    </div>
  </section>

  <input type="file" id="importFile" accept="application/json,.json" style="display:none;">
</main>

<script>
/* =========================
   ETHIR ATLAS ULTIMATE (single-file)
   ========================= */

const $ = (s, r=document) => r.querySelector(s);
const $$ = (s, r=document) => [...r.querySelectorAll(s)];
const uid = () => Date.now().toString(36) + Math.random().toString(36).slice(2,8);
const asNum = (v, f=0) => Number.isFinite(Number(v)) ? Number(v) : f;
const clamp = (n,a,b) => Math.max(a, Math.min(b, n));
const esc = (s) => String(s ?? '')
  .replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;')
  .replaceAll('"','&quot;').replaceAll("'","&#039;");

const STORAGE_KEY = "ether_atlas_ultimate_v1";

const saveDot = $("#saveDot");
let saveTimer = null;
function showError(msg){ $("#errorText").textContent = msg; $("#errorBar").style.display = "block"; }
function clearError(){ $("#errorBar").style.display = "none"; }
function flashSaved(){ saveDot.classList.add("show"); setTimeout(()=>saveDot.classList.remove("show"), 650); }
function scheduleSave(){ clearTimeout(saveTimer); saveTimer = setTimeout(saveState, 250); }

function normalizeTags(str){
  return String(str||"").split(",").map(s=>s.trim()).filter(Boolean).slice(0, 40);
}
function ensureTheme(name){
  const n = (name||"").trim(); if(!n) return;
  if(state.themes.some(t=>t.toLowerCase()===n.toLowerCase())) return;
  state.themes.push(n);
}
function ensureThemesFromTags(tags){ (tags||[]).forEach(ensureTheme); }

function nowIso(){ return new Date().toISOString(); }
function prettyDate(iso){
  try{
    const d = new Date(iso);
    return d.toLocaleString("ru-RU");
  }catch{ return iso; }
}

/* ===== Auto-chronicle ===== */
function addJournal(kind, title, text, meta={}){
  state.journal.unshift({
    id: uid(),
    at: nowIso(),
    kind,
    title: title || "–ó–∞–ø–∏—Å—å",
    text: text || "",
    meta
  });
  scheduleSave();
  renderJournal();
}

/* ===== Default state ===== */
function defaultState(){
  return {
    version: 1,
    ui: {
      tab: "world",
      mapMode: "markers",
      showLabels: true,
      fitMode: "contain",
      mapScale: 100,
      selected: { kind: null, id: null },
      linkFirstMarkerId: null,
      regionDraft: [],
      mapSearch: "",
      layerFilter: { politics:true, magic:true, war:true, secrets:true }
    },
    world: { logline:"", rules:"", themes:"", note:"" },
    themes: ["–ú–∞–≥–∏—è","–í–µ—Ä–∞","–£–ø–∞–¥–æ–∫","–í–æ–π–Ω–∞"],
    eras: [{ id: uid(), title: "–≠–ø–æ—Ö–∞ I ‚Äî –ù–∞—á–∞–ª–æ", from: 0, to: 100, summary: "–ü–µ—Ä–≤—ã–µ –∫–ª—è—Ç–≤—ã, –ø–µ—Ä–≤—ã–µ –∫–æ—Ä–æ–Ω—ã, –ø–µ—Ä–≤—ã–µ –ø—Ä–æ–∫–ª—è—Ç–∏—è." }],
    factions: [{ id: uid(), name: "–û—Ä–¥–µ–Ω –ü–µ–ø–ª–∞", color: "red", summary: "–û–Ω–∏ –≤–µ—Ä—è—Ç, —á—Ç–æ –º–∏—Ä –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ—á–∏—â–µ–Ω –æ–≥–Ω—ë–º." }],
    events: [],
    links: [],
    checkpoints: [],
    journal: [{ id: uid(), at: nowIso(), kind:"system", title:"–ê—Ç–ª–∞—Å —Å–æ–∑–¥–∞–Ω", text:"–≠—Ñ–∏—Ä –∂–¥—ë—Ç —Ç–≤–æ–µ–π –∏—Å—Ç–æ—Ä–∏–∏.", meta:{} }],
    map: { imageDataUrl:null, markers:[], regions:[], mapLinks:[] }
  };
}

function migrateState(s){
  const base = defaultState();
  if(!s || typeof s !== "object") return base;
  return {
    ...base,
    ...s,
    ui: { ...base.ui, ...(s.ui||{}) },
    world: { ...base.world, ...(s.world||{}) },
    eras: Array.isArray(s.eras) && s.eras.length ? s.eras : base.eras,
    factions: Array.isArray(s.factions) ? s.factions : base.factions,
    events: Array.isArray(s.events) ? s.events : [],
    links: Array.isArray(s.links) ? s.links : [],
    checkpoints: Array.isArray(s.checkpoints) ? s.checkpoints : [],
    journal: Array.isArray(s.journal) ? s.journal : base.journal,
    themes: Array.isArray(s.themes) ? s.themes : base.themes,
    map: {
      ...base.map,
      ...(s.map||{}),
      markers: Array.isArray(s.map?.markers) ? s.map.markers : [],
      regions: Array.isArray(s.map?.regions) ? s.map.regions : [],
      mapLinks: Array.isArray(s.map?.mapLinks) ? s.map.mapLinks : []
    }
  };
}

function loadState(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw) return defaultState();
    return migrateState(JSON.parse(raw));
  }catch(e){
    showError("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ. –°–æ–∑–¥–∞–Ω–æ –Ω–æ–≤–æ–µ.");
    return defaultState();
  }
}
function saveState(){
  try{
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    clearError();
    flashSaved();
  }catch(e){
    showError("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å. –í–æ–∑–º–æ–∂–Ω–æ, –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç –º–µ—Å—Ç–∞ ‚Äî —Å–¥–µ–ª–∞–π —ç–∫—Å–ø–æ—Ä—Ç.");
  }
}

let state = loadState();

/* ===== Themes (color grading) ===== */
const applyTheme = (t)=>{
  document.body.classList.remove("light","violet");
  if(t!=="dark") document.body.classList.add(t);
  localStorage.setItem("ether_theme", t);
};
$("#themeDark").onclick = ()=>applyTheme("dark");
$("#themeLight").onclick = ()=>applyTheme("light");
$("#themeViolet").onclick = ()=>applyTheme("violet");
applyTheme(localStorage.getItem("ether_theme") || "dark");

/* ===== Tabs ===== */
function openTab(id){
  state.ui.tab = id;
  $$("nav button[data-tab]").forEach(b=>b.classList.remove("active"));
  $$("main section").forEach(s=>s.classList.remove("active"));
  $(`nav button[data-tab="${id}"]`)?.classList.add("active");
  $(`#${id}`)?.classList.add("active");
  scheduleSave();
  if(id==="map") requestAnimationFrame(renderMap);
}
$$("nav button[data-tab]").forEach(b=>b.addEventListener("click", ()=>openTab(b.dataset.tab)));

/* ===== Export / Import ===== */
$("#exportBtn").addEventListener("click", ()=>{
  try{
    const data = JSON.stringify(state, null, 2);
    const blob = new Blob([data], {type:"application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `ether_atlas_${new Date().toISOString().slice(0,10)}.json`;
    a.click();
    setTimeout(()=>URL.revokeObjectURL(url), 1200);
  }catch{ showError("–≠–∫—Å–ø–æ—Ä—Ç –Ω–µ —É–¥–∞–ª—Å—è."); }
});
$("#importBtn").addEventListener("click", ()=>$("#importFile").click());
$("#importFile").addEventListener("change", (e)=>{
  const file = e.target.files && e.target.files[0];
  if(!file) return;
  const r = new FileReader();
  r.onload = ()=>{
    try{
      state = migrateState(JSON.parse(String(r.result||"{}")));
      saveState();
      renderAll();
      openTab(state.ui.tab || "world");
    }catch{ showError("–ù–µ–≤–µ—Ä–Ω—ã–π JSON —Ñ–∞–π–ª –∏–º–ø–æ—Ä—Ç–∞."); }
  };
  r.readAsText(file);
  e.target.value = "";
});

/* ===== World ===== */
function renderWorld(){
  $("#worldLogline").value = state.world.logline || "";
  $("#worldRules").value = state.world.rules || "";
  $("#worldThemes").value = state.world.themes || "";
  $("#worldNote").value = state.world.note || "";

  const wire = (id, key) => {
    $(id).addEventListener("input", ()=>{
      state.world[key] = $(id).value;
      scheduleSave();
    });
  };
  if(!renderWorld._wired){
    wire("#worldLogline","logline");
    wire("#worldRules","rules");
    wire("#worldThemes","themes");
    wire("#worldNote","note");
    $("#worldSaveBtn").addEventListener("click", ()=>{ saveState(); flashSaved(); });
    renderWorld._wired = true;
  }
}

/* ===== Map ===== */
const mapImg = $("#mapImg");
const mapFrame = $("#mapFrame");
const markerLayerDiv = $("#markerLayerDiv");
const labelLayerDiv = $("#labelLayerDiv");
const regionSvg = $("#regionSvg");
const linkSvg = $("#linkSvg");

function markerIcon(type){
  return ({
    city:"üè∞", village:"üèò", fort:"üõ°", tower:"üóº", ruins:"‚öî", dungeon:"üï≥",
    magic:"‚ú®", port:"‚öì", danger:"‚ò†"
  })[type] || "üìç";
}
function colorToRgba(color, a=0.92){
  const map = {
    gold:[233,207,103],
    white:[245,236,220],
    red:[190,70,70],
    blue:[80,130,220],
    green:[70,180,120],
    purple:[170,110,220]
  };
  const c = map[color] || map.gold;
  return `rgba(${c[0]},${c[1]},${c[2]},${a})`;
}
function restoreMapImage(){
  if(state.map.imageDataUrl){
    mapImg.src = state.map.imageDataUrl;
    mapImg.style.display = "block";
  }else{
    mapImg.style.display = "none";
  }
}
async function fileToDataUrl(file){
  return new Promise((resolve, reject)=>{
    const r = new FileReader();
    r.onload = ()=>resolve(String(r.result));
    r.onerror = reject;
    r.readAsDataURL(file);
  });
}

function rect(){ return mapFrame.getBoundingClientRect(); }
function clientToPercent(cx, cy){
  const r = rect();
  return { x: clamp((cx - r.left)/r.width, 0, 1), y: clamp((cy - r.top)/r.height, 0, 1) };
}
function percentToPx(p){
  const r = rect();
  return { x: p.x * r.width, y: p.y * r.height };
}
function getMarker(id){ return state.map.markers.find(m=>m.id===id); }
function getRegion(id){ return state.map.regions.find(r=>r.id===id); }
function getMapLink(id){ return state.map.mapLinks.find(l=>l.id===id); }

/* disable accidental zoom/pan */
mapFrame.addEventListener("wheel", (e)=>e.preventDefault(), {passive:false});
mapFrame.addEventListener("gesturestart", (e)=>e.preventDefault());
mapFrame.addEventListener("gesturechange", (e)=>e.preventDefault());
mapFrame.addEventListener("gestureend", (e)=>e.preventDefault());

function setLayerFilter(key){
  if(key==="all"){
    const anyOff = Object.values(state.ui.layerFilter).some(v=>!v);
    state.ui.layerFilter = { politics:anyOff, magic:anyOff, war:anyOff, secrets:anyOff };
  }else{
    state.ui.layerFilter[key] = !state.ui.layerFilter[key];
  }
  scheduleSave();
  renderMap();
  renderLayerPills();
}
function renderLayerPills(){
  const setPill = (id, on)=>{
    const el = $(id);
    el.classList.toggle("off", !on);
  };
  setPill("#layerPolitics", state.ui.layerFilter.politics);
  setPill("#layerMagic", state.ui.layerFilter.magic);
  setPill("#layerWar", state.ui.layerFilter.war);
  setPill("#layerSecrets", state.ui.layerFilter.secrets);
}

$("#layerPolitics").onclick = ()=>setLayerFilter("politics");
$("#layerMagic").onclick = ()=>setLayerFilter("magic");
$("#layerWar").onclick = ()=>setLayerFilter("war");
$("#layerSecrets").onclick = ()=>setLayerFilter("secrets");
$("#layerAll").onclick = ()=>setLayerFilter("all");

function setMapMode(mode){
  state.ui.mapMode = mode;
  $("#modeMarkers").classList.toggle("active", mode==="markers");
  $("#modeRegions").classList.toggle("active", mode==="regions");
  $("#modeLinks").classList.toggle("active", mode==="links");
  $("#modeView").classList.toggle("active", mode==="view");

  $("#markerCreate").style.display = (mode==="markers") ? "block" : "none";
  $("#regionCreate").style.display = (mode==="regions") ? "block" : "none";
  $("#linkCreate").style.display = (mode==="links") ? "block" : "none";

  $("#mapModePill").textContent =
    mode==="markers" ? "–†–µ–∂–∏–º: –û—Ç–º–µ—Ç–∫–∏" :
    mode==="regions" ? "–†–µ–∂–∏–º: –†–µ–≥–∏–æ–Ω—ã" :
    mode==="links" ? "–†–µ–∂–∏–º: –°–≤—è–∑–∏" : "–†–µ–∂–∏–º: –ü—Ä–æ—Å–º–æ—Ç—Ä";

  if(mode !== "links") state.ui.linkFirstMarkerId = null;
  if(mode !== "regions") state.ui.regionDraft = [];
  scheduleSave();
  renderMap();
  renderSelectedEditor();
}
$("#modeMarkers").onclick = ()=>setMapMode("markers");
$("#modeRegions").onclick = ()=>setMapMode("regions");
$("#modeLinks").onclick = ()=>setMapMode("links");
$("#modeView").onclick = ()=>setMapMode("view");

$("#mapUpload").addEventListener("change", async (e)=>{
  const file = e.target.files && e.target.files[0];
  if(!file) return;
  try{
    state.map.imageDataUrl = await fileToDataUrl(file);
    restoreMapImage();
    addJournal("map","–ó–∞–≥—Ä—É–∂–µ–Ω–∞ –∫–∞—Ä—Ç–∞","–ö–∞—Ä—Ç–∞ –º–∏—Ä–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞.");
    scheduleSave();
    renderMap();
  }catch{ showError("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–∞—Ä—Ç—É."); }
  e.target.value = "";
});

$("#fitMode").onchange = ()=>{
  state.ui.fitMode = $("#fitMode").value;
  scheduleSave();
  renderMap();
};
$("#mapScale").oninput = ()=>{
  const v = asNum($("#mapScale").value, 100);
  state.ui.mapScale = clamp(v, 70, 170);
  $("#mapScaleLabel").textContent = `${state.ui.mapScale}%`;
  scheduleSave();
  renderMap();
};
$("#toggleLabels").onchange = ()=>{
  state.ui.showLabels = $("#toggleLabels").checked;
  scheduleSave();
  renderMap();
};

$("#clearMap").onclick = ()=>{
  if(!confirm("–£–±—Ä–∞—Ç—å –∫–∞—Ä—Ç—É? (–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏—Å—á–µ–∑–Ω–µ—Ç, –Ω–æ –æ—Ç–º–µ—Ç–∫–∏ –æ—Å—Ç–∞–Ω—É—Ç—Å—è)")) return;
  state.map.imageDataUrl = null;
  restoreMapImage();
  addJournal("map","–ö–∞—Ä—Ç–∞ —É–±—Ä–∞–Ω–∞","–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–∞—Ä—Ç—ã —Å–∫—Ä—ã—Ç–æ.");
  scheduleSave();
  renderMap();
};
$("#clearMapObjects").onclick = ()=>{
  if(!confirm("–°—Ç–µ—Ä–µ—Ç—å –í–°–ï –æ—Ç–º–µ—Ç–∫–∏, —Ä–µ–≥–∏–æ–Ω—ã –∏ –ª–∏–Ω–∏–∏ –Ω–∞ –∫–∞—Ä—Ç–µ?")) return;
  state.map.markers = [];
  state.map.regions = [];
  state.map.mapLinks = [];
  state.ui.selected = {kind:null,id:null};
  state.ui.linkFirstMarkerId = null;
  state.ui.regionDraft = [];
  addJournal("map","–û—á–∏—â–µ–Ω–∞ –∫–∞—Ä—Ç–∞","–£–¥–∞–ª–µ–Ω—ã –æ—Ç–º–µ—Ç–∫–∏, —Ä–µ–≥–∏–æ–Ω—ã –∏ —Å–≤—è–∑–∏ –Ω–∞ –∫–∞—Ä—Ç–µ.");
  scheduleSave();
  renderMap();
  renderSelectedEditor();
  renderMapLists();
  renderSecrets();
};

function addMarker(p){
  const m = {
    id: uid(),
    x: p.x, y: p.y,
    type: $("#markerType").value,
    layer: $("#markerLayer").value,
    color: $("#markerColor").value,
    chapter: clamp(asNum($("#markerChapter").value,1), 1, 999999),
    title: "–ù–æ–≤–∞—è —Ç–æ—á–∫–∞",
    tags: normalizeTags($("#markerTags").value),
    note: "",
    secret: ""
  };
  ensureThemesFromTags(m.tags);
  state.map.markers.unshift(m);
  state.ui.selected = {kind:"marker", id:m.id};
  addJournal("map",`–û—Ç–º–µ—Ç–∫–∞: ${m.title}`,`–î–æ–±–∞–≤–ª–µ–Ω–∞ –æ—Ç–º–µ—Ç–∫–∞ ${markerIcon(m.type)} (${m.layer}).`);
  scheduleSave();
  renderMap();
  renderSelectedEditor();
  renderMapLists();
  renderSecrets();
}

function addMapLink(aId, bId){
  if(aId === bId) return;
  const exists = state.map.mapLinks.some(l => (l.a===aId && l.b===bId) || (l.a===bId && l.b===aId));
  if(exists) return;
  state.map.mapLinks.unshift({
    id: uid(),
    a: aId, b: bId,
    label: "",
    kind: "road",
    color: "white"
  });
}

function beginRegionPoint(p){
  state.ui.regionDraft.push({x:p.x,y:p.y});
  scheduleSave();
  renderMap();
}

$("#finishRegion").onclick = ()=>{
  if(state.ui.regionDraft.length < 3){
    alert("–ù—É–∂–Ω–æ –º–∏–Ω–∏–º—É–º 3 —Ç–æ—á–∫–∏ –¥–ª—è —Ä–µ–≥–∏–æ–Ω–∞.");
    return;
  }
  const layer = $("#regionLayerSel").value;
  const reg = {
    id: uid(),
    name: "–ù–æ–≤—ã–π —Ä–µ–≥–∏–æ–Ω",
    layer,
    color: "gold",
    factionId: "",
    tags: [],
    note: "",
    secret: "",
    points: state.ui.regionDraft
  };
  state.map.regions.unshift(reg);
  state.ui.regionDraft = [];
  state.ui.selected = {kind:"region", id: reg.id};
  addJournal("map",`–†–µ–≥–∏–æ–Ω: ${reg.name}`,`–°–æ–∑–¥–∞–Ω —Ä–µ–≥–∏–æ–Ω (${layer}).`);
  scheduleSave();
  renderMap();
  renderSelectedEditor();
  renderMapLists();
  renderSecrets();
};
$("#cancelRegion").onclick = ()=>{
  state.ui.regionDraft = [];
  scheduleSave();
  renderMap();
};

mapFrame.addEventListener("click", (e)=>{
  if(state.ui.mapMode === "view") return;
  if(mapImg.style.display === "none"){ alert("–°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏ –∫–∞—Ä—Ç—É."); return; }
  const p = clientToPercent(e.clientX, e.clientY);
  if(state.ui.mapMode === "markers") addMarker(p);
  else if(state.ui.mapMode === "regions") beginRegionPoint(p);
});

function renderMap(){
  // map view config
  mapImg.style.objectFit = state.ui.fitMode || "contain";
  const scale = clamp(asNum(state.ui.mapScale, 100), 70, 170) / 100;
  mapImg.style.transform = `scale(${scale})`;

  $("#fitMode").value = state.ui.fitMode || "contain";
  $("#mapScale").value = clamp(asNum(state.ui.mapScale,100), 70, 170);
  $("#mapScaleLabel").textContent = `${clamp(asNum(state.ui.mapScale,100), 70, 170)}%`;
  $("#toggleLabels").checked = !!state.ui.showLabels;

  markerLayerDiv.innerHTML = "";
  labelLayerDiv.innerHTML = "";
  regionSvg.innerHTML = "";
  linkSvg.innerHTML = "";

  renderLayerPills();

  const r = rect();
  for(const svg of [regionSvg, linkSvg]){
    svg.setAttribute("width", r.width);
    svg.setAttribute("height", r.height);
    svg.setAttribute("viewBox", `0 0 ${r.width} ${r.height}`);
  }

  // regions
  for(const reg of state.map.regions){
    if(!state.ui.layerFilter[reg.layer || "politics"]) continue;

    const pts = reg.points.map(percentToPx);
    const pointsStr = pts.map(p=>`${p.x},${p.y}`).join(" ");
    const poly = document.createElementNS("http://www.w3.org/2000/svg","polygon");
    poly.setAttribute("points", pointsStr);

    const faction = state.factions.find(f=>f.id===reg.factionId);
    const baseColor = faction ? faction.color : reg.color;

    poly.setAttribute("fill", colorToRgba(baseColor, 0.18));
    poly.setAttribute("stroke", colorToRgba(baseColor, 0.62));
    poly.setAttribute("stroke-width", "3");
    poly.style.cursor = "pointer";

    poly.addEventListener("click", (e)=>{
      e.stopPropagation();
      state.ui.selected = {kind:"region", id: reg.id};
      scheduleSave();
      renderMap();
      renderSelectedEditor();
    });

    if(state.ui.selected.kind==="region" && state.ui.selected.id===reg.id){
      poly.setAttribute("stroke", "rgba(255,255,255,.6)");
      poly.setAttribute("stroke-width", "4");
    }

    regionSvg.appendChild(poly);

    // label
    const cx = pts.reduce((a,p)=>a+p.x,0)/pts.length;
    const cy = pts.reduce((a,p)=>a+p.y,0)/pts.length;
    const t = document.createElementNS("http://www.w3.org/2000/svg","text");
    t.setAttribute("x", cx);
    t.setAttribute("y", cy);
    t.setAttribute("fill", "rgba(243,230,207,.88)");
    t.setAttribute("font-size", "14");
    t.setAttribute("font-weight", "900");
    t.setAttribute("text-anchor", "middle");
    t.style.pointerEvents = "none";
    t.textContent = reg.name;
    regionSvg.appendChild(t);
  }

  // region draft preview
  if(state.ui.mapMode==="regions" && state.ui.regionDraft.length){
    const pts = state.ui.regionDraft.map(percentToPx);
    const pl = document.createElementNS("http://www.w3.org/2000/svg","polyline");
    pl.setAttribute("points", pts.map(p=>`${p.x},${p.y}`).join(" "));
    pl.setAttribute("fill", "none");
    pl.setAttribute("stroke", "rgba(233,207,103,.85)");
    pl.setAttribute("stroke-width", "3");
    pl.setAttribute("stroke-dasharray", "7 7");
    regionSvg.appendChild(pl);
  }

  // map links (between markers)
  for(const l of state.map.mapLinks){
    const a = getMarker(l.a), b = getMarker(l.b);
    if(!a || !b) continue;

    // show link only if at least one endpoint is visible by layer filter
    if(!state.ui.layerFilter[a.layer || "politics"] && !state.ui.layerFilter[b.layer || "politics"]) continue;

    const ap = percentToPx(a);
    const bp = percentToPx(b);

    const line = document.createElementNS("http://www.w3.org/2000/svg","line");
    line.setAttribute("x1", ap.x);
    line.setAttribute("y1", ap.y);
    line.setAttribute("x2", bp.x);
    line.setAttribute("y2", bp.y);
    line.setAttribute("stroke", colorToRgba(l.color || "white", 0.65));
    line.setAttribute("stroke-width", "4");
    line.setAttribute("stroke-linecap", "round");
    linkSvg.appendChild(line);

    const hit = document.createElementNS("http://www.w3.org/2000/svg","line");
    hit.setAttribute("x1", ap.x); hit.setAttribute("y1", ap.y);
    hit.setAttribute("x2", bp.x); hit.setAttribute("y2", bp.y);
    hit.setAttribute("stroke", "rgba(0,0,0,0)");
    hit.setAttribute("stroke-width", "18");
    hit.style.pointerEvents = "stroke";
    hit.style.cursor = "pointer";
    hit.addEventListener("click", (e)=>{
      e.stopPropagation();
      state.ui.selected = {kind:"maplink", id: l.id};
      scheduleSave();
      renderMap();
      renderSelectedEditor();
    });
    linkSvg.appendChild(hit);

    if(l.label){
      const tx = (ap.x+bp.x)/2;
      const ty = (ap.y+bp.y)/2;
      const txt = document.createElementNS("http://www.w3.org/2000/svg","text");
      txt.setAttribute("x", tx);
      txt.setAttribute("y", ty);
      txt.setAttribute("fill", colorToRgba(l.color || "white", 0.82));
      txt.setAttribute("font-size", "13");
      txt.setAttribute("font-weight", "900");
      txt.setAttribute("text-anchor", "middle");
      txt.style.pointerEvents = "none";
      txt.textContent = l.label;
      linkSvg.appendChild(txt);
    }

    if(state.ui.selected.kind==="maplink" && state.ui.selected.id===l.id){
      line.setAttribute("stroke", "rgba(255,255,255,.65)");
      line.setAttribute("stroke-width", "5");
    }
  }

  // markers
  for(const m of state.map.markers){
    if(!state.ui.layerFilter[m.layer || "politics"]) continue;

    const px = percentToPx(m);
    const dot = document.createElement("div");
    dot.className = "marker" + ((state.ui.selected.kind==="marker" && state.ui.selected.id===m.id) ? " selected" : "");
    dot.style.left = `${px.x}px`;
    dot.style.top = `${px.y}px`;
    dot.style.background = colorToRgba(m.color || "gold", 0.92);
    dot.textContent = markerIcon(m.type);
    dot.title = `${m.title}\n${(m.tags||[]).join(", ")}`;

    dot.addEventListener("click", (e)=>{
      e.stopPropagation();
      state.ui.selected = {kind:"marker", id:m.id};

      if(state.ui.mapMode==="links"){
        if(!state.ui.linkFirstMarkerId){
          state.ui.linkFirstMarkerId = m.id;
          $("#linkHintPill").textContent = "–í—ã–±–µ—Ä–∏ –≤—Ç–æ—Ä—É—é –æ—Ç–º–µ—Ç–∫—É‚Ä¶";
        }else{
          addMapLink(state.ui.linkFirstMarkerId, m.id);
          state.ui.linkFirstMarkerId = null;
          $("#linkHintPill").textContent = "–ì–æ—Ç–æ–≤–æ. –ú–æ–∂–Ω–æ –µ—â—ë.";
          addJournal("map","–°–≤—è–∑—å –Ω–∞ –∫–∞—Ä—Ç–µ","–°–æ–∑–¥–∞–Ω–∞ –ª–∏–Ω–∏—è –º–µ–∂–¥—É –æ—Ç–º–µ—Ç–∫–∞–º–∏.");
        }
        scheduleSave();
      }

      renderMap();
      renderSelectedEditor();
      renderMapLists();
    });

    // drag marker only in marker mode
    dot.addEventListener("mousedown", (e)=>{
      if(state.ui.mapMode !== "markers") return;
      state.ui.dragging = m.id;
      e.preventDefault();
      e.stopPropagation();
    });

    markerLayerDiv.appendChild(dot);

    if(state.ui.showLabels){
      const lab = document.createElement("div");
      lab.className = "markerLabel";
      lab.style.left = `${px.x}px`;
      lab.style.top = `${px.y}px`;
      lab.textContent = m.title || "‚Ä¶";
      labelLayerDiv.appendChild(lab);
    }
  }
}

document.addEventListener("mousemove", (e)=>{
  const id = state.ui.dragging;
  if(!id) return;
  const m = getMarker(id);
  if(!m) return;
  const p = clientToPercent(e.clientX, e.clientY);
  m.x = p.x; m.y = p.y;
  scheduleSave();
  renderMap();
});
document.addEventListener("mouseup", ()=>{ state.ui.dragging = null; });

window.addEventListener("resize", ()=>{ if($("#map").classList.contains("active")) renderMap(); });

function renderSelectedEditor(){
  const sel = state.ui.selected;
  const pill = $("#selectedPill");
  const editor = $("#selectedEditor");

  if(!sel.kind){
    pill.textContent = "–Ω–∏—á–µ–≥–æ";
    editor.innerHTML = `<div class="small">–í—ã–±–µ—Ä–∏ –æ—Ç–º–µ—Ç–∫—É/—Ä–µ–≥–∏–æ–Ω/–ª–∏–Ω–∏—é –Ω–∞ –∫–∞—Ä—Ç–µ, —á—Ç–æ–±—ã —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å.</div>`;
    return;
  }

  if(sel.kind === "marker"){
    const m = getMarker(sel.id);
    if(!m){ state.ui.selected={kind:null,id:null}; renderSelectedEditor(); return; }
    pill.textContent = "–æ—Ç–º–µ—Ç–∫–∞";

    editor.innerHTML = `
      <h3>–û—Ç–º–µ—Ç–∫–∞</h3>
      <label>–ù–∞–∑–≤–∞–Ω–∏–µ (–ø–æ–¥–ø–∏—Å—å)</label>
      <input id="em_title" value="${esc(m.title)}">

      <div class="row">
        <div style="flex:1;">
          <label>–¢–∏–ø</label>
          <select id="em_type">
            <option value="city">üè∞ –ì–æ—Ä–æ–¥</option>
            <option value="village">üèò –î–µ—Ä–µ–≤–Ω—è</option>
            <option value="fort">üõ° –ö—Ä–µ–ø–æ—Å—Ç—å</option>
            <option value="tower">üóº –ë–∞—à–Ω—è</option>
            <option value="ruins">‚öî –†—É–∏–Ω—ã</option>
            <option value="dungeon">üï≥ –ü–æ–¥–∑–µ–º–µ–ª—å–µ</option>
            <option value="magic">‚ú® –ú–∞–≥–∏—á–µ—Å–∫–æ–µ –º–µ—Å—Ç–æ</option>
            <option value="port">‚öì –ü–æ—Ä—Ç</option>
            <option value="danger">‚ò† –û–ø–∞—Å–Ω–æ—Å—Ç—å</option>
          </select>
        </div>
        <div style="flex:1;">
          <label>–°–ª–æ–π</label>
          <select id="em_layer">
            <option value="politics">üèõ –ü–æ–ª–∏—Ç–∏–∫–∞</option>
            <option value="magic">‚ú® –ú–∞–≥–∏—è</option>
            <option value="war">‚öî –í–æ–π–Ω–∞</option>
            <option value="secrets">üîÆ –¢–∞–π–Ω—ã</option>
          </select>
        </div>
      </div>

      <div class="row">
        <div style="flex:1;">
          <label>–¶–≤–µ—Ç</label>
          <select id="em_color">
            <option value="gold">–ó–æ–ª–æ—Ç–æ</option>
            <option value="white">–ë–µ–ª—ã–π</option>
            <option value="red">–ö—Ä–∞—Å–Ω—ã–π</option>
            <option value="blue">–°–∏–Ω–∏–π</option>
            <option value="green">–ó–µ–ª—ë–Ω—ã–π</option>
            <option value="purple">–§–∏–æ–ª–µ—Ç–æ–≤—ã–π</option>
          </select>
        </div>
        <div style="flex:1;">
          <label>–ì–ª–∞–≤–∞</label>
          <input id="em_ch" type="number" min="1" value="${asNum(m.chapter,1)}">
        </div>
      </div>

      <label>–¢–µ–≥–∏ (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)</label>
      <input id="em_tags" value="${esc((m.tags||[]).join(", "))}">

      <label>–ó–∞–º–µ—Ç–∫–∞</label>
      <textarea id="em_note">${esc(m.note||"")}</textarea>

      <label>üîÆ –¢–∞–π–Ω–∞—è –∑–∞–º–µ—Ç–∫–∞</label>
      <textarea id="em_secret" placeholder="–ø—Ä–æ—Ä–æ—á–µ—Å—Ç–≤–∞, —Å–∫—Ä—ã—Ç—ã–µ –ø—Ä–∏—á–∏–Ω—ã‚Ä¶">${esc(m.secret||"")}</textarea>

      <div class="row" style="margin-top:10px;">
        <button class="btn ok small" id="em_save">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <button class="btn danger small" id="em_del">üóë –£–¥–∞–ª–∏—Ç—å</button>
      </div>
    `;

    $("#em_type").value = m.type || "city";
    $("#em_color").value = m.color || "gold";
    $("#em_layer").value = m.layer || "politics";

    $("#em_save").onclick = ()=>{
      m.title = ($("#em_title").value || "").trim() || "–û—Ç–º–µ—Ç–∫–∞";
      m.type = $("#em_type").value;
      m.layer = $("#em_layer").value;
      m.color = $("#em_color").value;
      m.chapter = clamp(asNum($("#em_ch").value,1), 1, 999999);
      m.tags = normalizeTags($("#em_tags").value);
      m.note = $("#em_note").value || "";
      m.secret = $("#em_secret").value || "";
      ensureThemesFromTags(m.tags);
      addJournal("map","–û—Ç–º–µ—Ç–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∞",`${m.title} –æ–±–Ω–æ–≤–ª–µ–Ω–∞.`);
      scheduleSave();
      renderMap();
      renderMapLists();
      renderSecrets();
    };
    $("#em_del").onclick = ()=>{
      if(!confirm("–£–¥–∞–ª–∏—Ç—å –æ—Ç–º–µ—Ç–∫—É? –õ–∏–Ω–∏–∏ —Å –Ω–µ–π —Ç–æ–∂–µ –ø—Ä–æ–ø–∞–¥—É—Ç.")) return;
      addJournal("map","–£–¥–∞–ª–µ–Ω–∞ –æ—Ç–º–µ—Ç–∫–∞",`–£–¥–∞–ª–µ–Ω–∞: ${m.title}`);
      state.map.markers = state.map.markers.filter(x=>x.id!==m.id);
      state.map.mapLinks = state.map.mapLinks.filter(l=>l.a!==m.id && l.b!==m.id);
      state.ui.selected = {kind:null,id:null};
      scheduleSave();
      renderMap();
      renderSelectedEditor();
      renderMapLists();
      renderSecrets();
    };
    return;
  }

  if(sel.kind === "region"){
    const r = getRegion(sel.id);
    if(!r){ state.ui.selected={kind:null,id:null}; renderSelectedEditor(); return; }
    pill.textContent = "—Ä–µ–≥–∏–æ–Ω";

    const factionOptions = [`<option value="">‚Äî –Ω–µ—Ç ‚Äî</option>`].concat(
      state.factions.map(f=>`<option value="${esc(f.id)}">${esc(f.name)}</option>`)
    ).join("");

    editor.innerHTML = `
      <h3>–†–µ–≥–∏–æ–Ω</h3>
      <label>–ù–∞–∑–≤–∞–Ω–∏–µ</label>
      <input id="er_name" value="${esc(r.name)}">

      <div class="row">
        <div style="flex:1;">
          <label>–°–ª–æ–π</label>
          <select id="er_layer">
            <option value="politics">üèõ –ü–æ–ª–∏—Ç–∏–∫–∞</option>
            <option value="magic">‚ú® –ú–∞–≥–∏—è</option>
            <option value="war">‚öî –í–æ–π–Ω–∞</option>
            <option value="secrets">üîÆ –¢–∞–π–Ω—ã</option>
          </select>
        </div>
        <div style="flex:1;">
          <label>–¶–≤–µ—Ç</label>
          <select id="er_color">
            <option value="gold">–ó–æ–ª–æ—Ç–æ</option>
            <option value="white">–ë–µ–ª—ã–π</option>
            <option value="red">–ö—Ä–∞—Å–Ω—ã–π</option>
            <option value="blue">–°–∏–Ω–∏–π</option>
            <option value="green">–ó–µ–ª—ë–Ω—ã–π</option>
            <option value="purple">–§–∏–æ–ª–µ—Ç–æ–≤—ã–π</option>
          </select>
        </div>
      </div>

      <label>–§—Ä–∞–∫—Ü–∏—è-–≤–ª–∏—è–Ω–∏–µ</label>
      <select id="er_faction">${factionOptions}</select>

      <label>–¢–µ–≥–∏</label>
      <input id="er_tags" value="${esc((r.tags||[]).join(", "))}">

      <label>–û–ø–∏—Å–∞–Ω–∏–µ</label>
      <textarea id="er_note">${esc(r.note||"")}</textarea>

      <label>üîÆ –¢–∞–π–Ω–∞—è –∑–∞–º–µ—Ç–∫–∞</label>
      <textarea id="er_secret">${esc(r.secret||"")}</textarea>

      <div class="row" style="margin-top:10px;">
        <button class="btn ok small" id="er_save">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <button class="btn danger small" id="er_del">üóë –£–¥–∞–ª–∏—Ç—å</button>
      </div>
    `;

    $("#er_color").value = r.color || "gold";
    $("#er_faction").value = r.factionId || "";
    $("#er_layer").value = r.layer || "politics";

    $("#er_save").onclick = ()=>{
      r.name = ($("#er_name").value || "").trim() || "–†–µ–≥–∏–æ–Ω";
      r.layer = $("#er_layer").value;
      r.color = $("#er_color").value;
      r.factionId = $("#er_faction").value || "";
      r.tags = normalizeTags($("#er_tags").value);
      r.note = $("#er_note").value || "";
      r.secret = $("#er_secret").value || "";
      ensureThemesFromTags(r.tags);
      addJournal("map","–†–µ–≥–∏–æ–Ω –∏–∑–º–µ–Ω—ë–Ω",`${r.name} –æ–±–Ω–æ–≤–ª—ë–Ω.`);
      scheduleSave();
      renderMap();
      renderMapLists();
      renderSecrets();
    };
    $("#er_del").onclick = ()=>{
      if(!confirm("–£–¥–∞–ª–∏—Ç—å —Ä–µ–≥–∏–æ–Ω?")) return;
      addJournal("map","–£–¥–∞–ª—ë–Ω —Ä–µ–≥–∏–æ–Ω",`–£–¥–∞–ª—ë–Ω: ${r.name}`);
      state.map.regions = state.map.regions.filter(x=>x.id!==r.id);
      state.ui.selected = {kind:null,id:null};
      scheduleSave();
      renderMap();
      renderSelectedEditor();
      renderMapLists();
      renderSecrets();
    };
    return;
  }

  if(sel.kind === "maplink"){
    const l = getMapLink(sel.id);
    if(!l){ state.ui.selected={kind:null,id:null}; renderSelectedEditor(); return; }
    pill.textContent = "–ª–∏–Ω–∏—è";

    const a = getMarker(l.a), b = getMarker(l.b);
    editor.innerHTML = `
      <h3>–õ–∏–Ω–∏—è –Ω–∞ –∫–∞—Ä—Ç–µ</h3>
      <div class="small">–°–≤—è–∑—å: <b>${esc(a?.title||"A")}</b> ‚Üî <b>${esc(b?.title||"B")}</b></div>

      <label>–ü–æ–¥–ø–∏—Å—å</label>
      <input id="el_label" value="${esc(l.label||"")}">

      <label>–¢–∏–ø</label>
      <select id="el_kind">
        <option value="road">–î–æ—Ä–æ–≥–∞</option>
        <option value="portal">–ü–æ—Ä—Ç–∞–ª</option>
        <option value="blood">–ö—Ä–æ–≤–Ω–∞—è –≤—Ä–∞–∂–¥–∞</option>
        <option value="oath">–ö–ª—è—Ç–≤–∞/—Å–æ—é–∑</option>
      </select>

      <label>–¶–≤–µ—Ç</label>
      <select id="el_color">
        <option value="white">–ë–µ–ª—ã–π</option>
        <option value="gold">–ó–æ–ª–æ—Ç–æ</option>
        <option value="red">–ö—Ä–∞—Å–Ω—ã–π</option>
        <option value="blue">–°–∏–Ω–∏–π</option>
        <option value="green">–ó–µ–ª—ë–Ω—ã–π</option>
        <option value="purple">–§–∏–æ–ª–µ—Ç–æ–≤—ã–π</option>
      </select>

      <div class="row" style="margin-top:10px;">
        <button class="btn ok small" id="el_save">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <button class="btn danger small" id="el_del">üóë –£–¥–∞–ª–∏—Ç—å</button>
      </div>
    `;

    $("#el_kind").value = l.kind || "road";
    $("#el_color").value = l.color || "white";

    $("#el_save").onclick = ()=>{
      l.label = $("#el_label").value || "";
      l.kind = $("#el_kind").value;
      l.color = $("#el_color").value;
      addJournal("map","–õ–∏–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∞",`–°–≤—è–∑—å –Ω–∞ –∫–∞—Ä—Ç–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∞.`);
      scheduleSave();
      renderMap();
      renderMapLists();
    };
    $("#el_del").onclick = ()=>{
      if(!confirm("–£–¥–∞–ª–∏—Ç—å –ª–∏–Ω–∏—é?")) return;
      addJournal("map","–õ–∏–Ω–∏—è —É–¥–∞–ª–µ–Ω–∞",`–°–≤—è–∑—å –Ω–∞ –∫–∞—Ä—Ç–µ —É–¥–∞–ª–µ–Ω–∞.`);
      state.map.mapLinks = state.map.mapLinks.filter(x=>x.id!==l.id);
      state.ui.selected = {kind:null,id:null};
      scheduleSave();
      renderMap();
      renderSelectedEditor();
      renderMapLists();
    };
    return;
  }
}

function renderMapLists(){
  const q = (state.ui.mapSearch || "").trim().toLowerCase();
  const filter = (txt) => !q || String(txt||"").toLowerCase().includes(q);

  const markers = state.map.markers.slice().sort((a,b)=> (a.title||"").localeCompare(b.title||"", "ru"));
  const regions = state.map.regions.slice().sort((a,b)=> (a.name||"").localeCompare(b.name||"", "ru"));
  const links = state.map.mapLinks.slice();

  const mk = markers.filter(m=> filter(m.title) || filter((m.tags||[]).join(",")) || filter(m.note));
  const rg = regions.filter(r=> filter(r.name) || filter((r.tags||[]).join(",")) || filter(r.note));
  const lk = links.filter(l=>{
    const a=getMarker(l.a), b=getMarker(l.b);
    const txt = `${a?.title||""} ${b?.title||""} ${l.label||""} ${l.kind||""}`;
    return filter(txt);
  });

  const block = (title, body) => `
    <div class="hr"></div>
    <h3>${title}</h3>
    ${body || `<div class="small">–ø—É—Å—Ç–æ</div>`}
  `;

  const markerRows = mk.map(m=>`
    <div class="row" style="padding:8px 0; border-bottom:1px solid rgba(233,207,103,.08);">
      <span class="pill">${markerIcon(m.type)} ${esc(m.title)}</span>
      <span class="pill">${m.layer || "‚Äî"}</span>
      <span class="pill">–≥–ª.${asNum(m.chapter,1)}</span>
      <div class="spacer"></div>
      <button class="btn ghost small" data-pick="marker:${m.id}">–í—ã–±—Ä–∞—Ç—å</button>
    </div>
  `).join("");

  const regionRows = rg.map(r=>`
    <div class="row" style="padding:8px 0; border-bottom:1px solid rgba(233,207,103,.08);">
      <span class="pill">üó∫ ${esc(r.name)}</span>
      <span class="pill">${r.layer || "‚Äî"}</span>
      <div class="spacer"></div>
      <button class="btn ghost small" data-pick="region:${r.id}">–í—ã–±—Ä–∞—Ç—å</button>
    </div>
  `).join("");

  const linkRows = lk.map(l=>{
    const a=getMarker(l.a), b=getMarker(l.b);
    const name = `${esc(a?.title||"A")} ‚Üî ${esc(b?.title||"B")}${l.label?(" ‚Äî "+esc(l.label)):""}`;
    return `
      <div class="row" style="padding:8px 0; border-bottom:1px solid rgba(233,207,103,.08);">
        <span class="pill">üîó ${name}</span>
        <div class="spacer"></div>
        <button class="btn ghost small" data-pick="maplink:${l.id}">–í—ã–±—Ä–∞—Ç—å</button>
      </div>
    `;
  }).join("");

  $("#mapLists").innerHTML =
    block(`–û—Ç–º–µ—Ç–∫–∏ (${mk.length})`, markerRows) +
    block(`–†–µ–≥–∏–æ–Ω—ã (${rg.length})`, regionRows) +
    block(`–õ–∏–Ω–∏–∏ (${lk.length})`, linkRows);

  $$("[data-pick]", $("#mapLists")).forEach(btn=>{
    btn.onclick = ()=>{
      const [kind,id] = btn.dataset.pick.split(":");
      state.ui.selected = {kind, id};
      scheduleSave();
      renderMap();
      renderSelectedEditor();
    };
  });
}

$("#mapSearch").oninput = ()=>{
  state.ui.mapSearch = $("#mapSearch").value || "";
  scheduleSave();
  renderMapLists();
};

/* Create marker / region / link modes */
function setMapModePill(mode){
  $("#mapModePill").textContent =
    mode==="markers" ? "–†–µ–∂–∏–º: –û—Ç–º–µ—Ç–∫–∏" :
    mode==="regions" ? "–†–µ–∂–∏–º: –†–µ–≥–∏–æ–Ω—ã" :
    mode==="links" ? "–†–µ–∂–∏–º: –°–≤—è–∑–∏" : "–†–µ–∂–∏–º: –ü—Ä–æ—Å–º–æ—Ç—Ä";
}

function initMapUi(){
  $("#fitMode").value = state.ui.fitMode || "contain";
  $("#mapScale").value = clamp(asNum(state.ui.mapScale,100), 70, 170);
  $("#mapScaleLabel").textContent = `${clamp(asNum(state.ui.mapScale,100), 70, 170)}%`;
  $("#toggleLabels").checked = !!state.ui.showLabels;
  setMapMode(state.ui.mapMode || "markers");
  setMapModePill(state.ui.mapMode || "markers");
  renderLayerPills();
}

function addMapLinkFlow(markerId){
  if(!state.ui.linkFirstMarkerId){
    state.ui.linkFirstMarkerId = markerId;
    $("#linkHintPill").textContent = "–í—ã–±–µ—Ä–∏ –≤—Ç–æ—Ä—É—é –æ—Ç–º–µ—Ç–∫—É‚Ä¶";
  }else{
    addMapLink(state.ui.linkFirstMarkerId, markerId);
    state.ui.linkFirstMarkerId = null;
    $("#linkHintPill").textContent = "–ì–æ—Ç–æ–≤–æ. –ú–æ–∂–Ω–æ –µ—â—ë.";
    addJournal("map","–°–≤—è–∑—å –Ω–∞ –∫–∞—Ä—Ç–µ","–°–æ–∑–¥–∞–Ω–∞ –ª–∏–Ω–∏—è –º–µ–∂–¥—É –æ—Ç–º–µ—Ç–∫–∞–º–∏.");
  }
  scheduleSave();
}

/* ===== Timeline (eras) ===== */
function renderEras(){
  const grid = $("#erasGrid");
  const eras = state.eras;

  const min = Math.min(...eras.map(e=>asNum(e.from,0)));
  const max = Math.max(...eras.map(e=>asNum(e.to,1)));
  const span = Math.max(1, max - min);

  grid.innerHTML = eras.map(e=>{
    const start = asNum(e.from,0);
    const end = asNum(e.to,1);
    const left = ((start - min) / span) * 100;
    const width = (Math.max(1, end - start) / span) * 100;

    return `
      <div class="card paper">
        <div class="row">
          <span class="pill">‚è≥ –≠–ø–æ—Ö–∞</span>
          <div class="spacer"></div>
          <button class="btn danger small" data-delera="${e.id}">üóë</button>
        </div>

        <label>–ù–∞–∑–≤–∞–Ω–∏–µ</label>
        <input data-era="${e.id}:title" value="${esc(e.title||"")}">

        <div class="row">
          <div style="flex:1;">
            <label>–û—Ç</label>
            <input data-era="${e.id}:from" type="number" value="${esc(e.from)}">
          </div>
          <div style="flex:1;">
            <label>–î–æ</label>
            <input data-era="${e.id}:to" type="number" value="${esc(e.to)}">
          </div>
        </div>

        <div class="timelineBar">
          <div class="timelineFill" style="left:${left}%; width:${width}%;"></div>
        </div>

        <label>–ö—Ä–∞—Ç–∫–æ</label>
        <textarea data-era="${e.id}:summary" placeholder="–ª–µ–≥–µ–Ω–¥–∞ —ç–ø–æ—Ö–∏‚Ä¶">${esc(e.summary||"")}</textarea>
      </div>
    `;
  }).join("");

  $$("[data-era]", grid).forEach(el=>{
    el.oninput = ()=>{
      const [id, field] = el.dataset.era.split(":");
      const era = state.eras.find(x=>x.id===id);
      if(!era) return;
      if(field==="title") era.title = el.value;
      if(field==="from") era.from = asNum(el.value, 0);
      if(field==="to") era.to = asNum(el.value, 1);
      if(field==="summary") era.summary = el.value;
      scheduleSave();
      renderEras();
    };
  });

  $$("[data-delera]", grid).forEach(btn=>{
    btn.onclick = ()=>{
      if(state.eras.length<=1){ alert("–ù—É–∂–Ω–∞ –º–∏–Ω–∏–º—É–º 1 —ç–ø–æ—Ö–∞."); return; }
      if(!confirm("–£–¥–∞–ª–∏—Ç—å —ç–ø–æ—Ö—É?")) return;
      state.eras = state.eras.filter(x=>x.id!==btn.dataset.delera);
      addJournal("timeline","–≠–ø–æ—Ö–∞ —É–¥–∞–ª–µ–Ω–∞","–£–¥–∞–ª–µ–Ω–∞ —ç–ø–æ—Ö–∞ –∏–∑ —Ç–∞–π–º–ª–∞–π–Ω–∞.");
      scheduleSave();
      renderEras();
    };
  });

  if(!renderEras._wired){
    $("#addEraBtn").onclick = ()=>{
      state.eras.unshift({ id: uid(), title: "–ù–æ–≤–∞—è —ç–ø–æ—Ö–∞", from: 0, to: 100, summary: "" });
      addJournal("timeline","–ù–æ–≤–∞—è —ç–ø–æ—Ö–∞","–î–æ–±–∞–≤–ª–µ–Ω–∞ —ç–ø–æ—Ö–∞ –≤ —Ç–∞–π–º–ª–∞–π–Ω.");
      scheduleSave();
      renderEras();
    };
    renderEras._wired = true;
  }
}

/* ===== Factions ===== */
function renderFactions(){
  const grid = $("#factionsGrid");
  grid.innerHTML = state.factions.map(f=>`
    <div class="card paper">
      <div class="row">
        <span class="pill">ü©∏ –§—Ä–∞–∫—Ü–∏—è</span>
        <div class="spacer"></div>
        <button class="btn danger small" data-delf="${f.id}">üóë</button>
      </div>

      <label>–ù–∞–∑–≤–∞–Ω–∏–µ</label>
      <input data-fac="${f.id}:name" value="${esc(f.name||"")}">

      <label>–¶–≤–µ—Ç –≤–ª–∏—è–Ω–∏—è</label>
      <select data-fac="${f.id}:color">
        <option value="red">–ö—Ä–∞—Å–Ω—ã–π</option>
        <option value="gold">–ó–æ–ª–æ—Ç–æ</option>
        <option value="white">–ë–µ–ª—ã–π</option>
        <option value="blue">–°–∏–Ω–∏–π</option>
        <option value="green">–ó–µ–ª—ë–Ω—ã–π</option>
        <option value="purple">–§–∏–æ–ª–µ—Ç–æ–≤—ã–π</option>
      </select>

      <label>–ö—Ä–∞—Ç–∫–æ</label>
      <textarea data-fac="${f.id}:summary" placeholder="–∏—Ö –∫–ª—è—Ç–≤–∞, –∏–¥–µ–æ–ª–æ–≥–∏—è, —Ü–µ–Ω–∞‚Ä¶">${esc(f.summary||"")}</textarea>
    </div>
  `).join("");

  $$("[data-fac]", grid).forEach(el=>{
    const [id, field] = el.dataset.fac.split(":");
    const fac = state.factions.find(x=>x.id===id);
    if(!fac) return;
    if(field==="color" && el.tagName==="SELECT") el.value = fac.color || "red";

    el.oninput = ()=>{
      const [id2, field2] = el.dataset.fac.split(":");
      const fac2 = state.factions.find(x=>x.id===id2);
      if(!fac2) return;
      if(field2==="name") fac2.name = el.value;
      if(field2==="color") fac2.color = el.value;
      if(field2==="summary") fac2.summary = el.value;
      scheduleSave();
      renderMap();
      renderSelectedEditor();
    };
  });

  $$("[data-delf]", grid).forEach(btn=>{
    btn.onclick = ()=>{
      if(!confirm("–£–¥–∞–ª–∏—Ç—å —Ñ—Ä–∞–∫—Ü–∏—é? –†–µ–≥–∏–æ–Ω—ã –ø–æ—Ç–µ—Ä—è—é—Ç —Å—Å—ã–ª–∫—É –Ω–∞ –Ω–µ—ë.")) return;
      const id = btn.dataset.delf;
      state.factions = state.factions.filter(x=>x.id!==id);
      state.map.regions.forEach(r=>{ if(r.factionId===id) r.factionId=""; });
      addJournal("faction","–§—Ä–∞–∫—Ü–∏—è —É–¥–∞–ª–µ–Ω–∞","–£–¥–∞–ª–µ–Ω–∞ —Ñ—Ä–∞–∫—Ü–∏—è.");
      scheduleSave();
      renderFactions();
      renderMap();
      renderSelectedEditor();
    };
  });

  if(!renderFactions._wired){
    $("#addFactionBtn").onclick = ()=>{
      state.factions.unshift({ id: uid(), name:"–ù–æ–≤–∞—è —Ñ—Ä–∞–∫—Ü–∏—è", color:"red", summary:"" });
      addJournal("faction","–ù–æ–≤–∞—è —Ñ—Ä–∞–∫—Ü–∏—è","–î–æ–±–∞–≤–ª–µ–Ω–∞ —Ñ—Ä–∞–∫—Ü–∏—è.");
      scheduleSave();
      renderFactions();
    };
    renderFactions._wired = true;
  }
}

/* ===== Events ===== */
function renderEvents(){
  const grid = $("#eventsGrid");
  if(!state.events.length){
    grid.innerHTML = `<div class="card paper"><div class="hint">–ü–æ–∫–∞ –Ω–µ—Ç —Å–æ–±—ã—Ç–∏–π. –°–æ–∑–¥–∞–π –ø–µ—Ä–≤–æ–µ ‚Äî –∏ —Ö—Ä–æ–Ω–∏–∫–∞ –Ω–∞—á–Ω—ë—Ç –∂–∏—Ç—å.</div></div>`;
  }else{
    grid.innerHTML = state.events.map(ev=>`
      <div class="card paper">
        <div class="row">
          <span class="pill">üìå –°–æ–±—ã—Ç–∏–µ</span>
          <div class="spacer"></div>
          <button class="btn danger small" data-delev="${ev.id}">üóë</button>
        </div>

        <label>–ù–∞–∑–≤–∞–Ω–∏–µ</label>
        <input data-ev="${ev.id}:title" value="${esc(ev.title||"")}">

        <div class="row">
          <div style="flex:1;">
            <label>–ì–ª–∞–≤–∞</label>
            <input data-ev="${ev.id}:chapter" type="number" min="1" value="${asNum(ev.chapter,1)}">
          </div>
          <div style="flex:2;">
            <label>–¢–µ–≥–∏</label>
            <input data-ev="${ev.id}:tags" value="${esc((ev.tags||[]).join(", "))}">
          </div>
        </div>

        <label>–ö—Ä–∞—Ç–∫–æ</label>
        <textarea data-ev="${ev.id}:summary" placeholder="—á—Ç–æ –ø—Ä–æ–∏–∑–æ—à–ª–æ?">${esc(ev.summary||"")}</textarea>

        <label>–î–µ—Ç–∞–ª–∏</label>
        <textarea data-ev="${ev.id}:note" placeholder="–ø—Ä–∏—á–∏–Ω—ã, –ø–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è‚Ä¶">${esc(ev.note||"")}</textarea>

        <label>üîÆ –¢–∞–π–Ω–æ–µ</label>
        <textarea data-ev="${ev.id}:secret">${esc(ev.secret||"")}</textarea>
      </div>
    `).join("");
  }

  $$("[data-ev]", grid).forEach(el=>{
    el.oninput = ()=>{
      const [id, field] = el.dataset.ev.split(":");
      const ev = state.events.find(x=>x.id===id);
      if(!ev) return;
      if(field==="title") ev.title = el.value;
      if(field==="chapter") ev.chapter = clamp(asNum(el.value,1), 1, 999999);
      if(field==="tags"){ ev.tags = normalizeTags(el.value); ensureThemesFromTags(ev.tags); }
      if(field==="summary") ev.summary = el.value;
      if(field==="note") ev.note = el.value;
      if(field==="secret") ev.secret = el.value;
      scheduleSave();
      renderSecrets();
    };
  });

  $$("[data-delev]", grid).forEach(btn=>{
    btn.onclick = ()=>{
      if(!confirm("–£–¥–∞–ª–∏—Ç—å —Å–æ–±—ã—Ç–∏–µ?")) return;
      state.events = state.events.filter(x=>x.id!==btn.dataset.delev);
      addJournal("event","–°–æ–±—ã—Ç–∏–µ —É–¥–∞–ª–µ–Ω–æ","–£–¥–∞–ª–µ–Ω–æ —Å–æ–±—ã—Ç–∏–µ.");
      scheduleSave();
      renderEvents();
      renderSecrets();
    };
  });

  if(!renderEvents._wired){
    $("#addEventBtn").onclick = ()=>{
      const ev = { id: uid(), title:"–ù–æ–≤–æ–µ —Å–æ–±—ã—Ç–∏–µ", chapter:1, tags:[], summary:"", note:"", secret:"" };
      state.events.unshift(ev);
      addJournal("event",`–°–æ–±—ã—Ç–∏–µ: ${ev.title}`,"–°–æ–∑–¥–∞–Ω–æ –Ω–æ–≤–æ–µ —Å–æ–±—ã—Ç–∏–µ.");
      scheduleSave();
      renderEvents();
      renderSecrets();
    };
    renderEvents._wired = true;
  }
}

/* ===== Universal Links ===== */
function allEntitiesForLinks(){
  const out = [];
  const push = (kind, id, label) => out.push({ kind, id, label });

  state.events.forEach(x=>push("event", x.id, `üìå ${x.title}`));
  state.factions.forEach(x=>push("faction", x.id, `ü©∏ ${x.name}`));
  state.map.markers.forEach(x=>push("mapMarker", x.id, `üìç ${x.title}`));
  state.map.regions.forEach(x=>push("mapRegion", x.id, `üó∫ ${x.name}`));

  return out;
}
function entityLabel(ref){
  if(!ref) return "‚Äî";
  const {kind,id} = ref;
  if(kind==="event") return `üìå ${state.events.find(x=>x.id===id)?.title || "?"}`;
  if(kind==="faction") return `ü©∏ ${state.factions.find(x=>x.id===id)?.name || "?"}`;
  if(kind==="mapMarker") return `üìç ${getMarker(id)?.title || "?"}`;
  if(kind==="mapRegion") return `üó∫ ${getRegion(id)?.name || "?"}`;
  return "‚Äî";
}

function renderLinks(){
  const grid = $("#linksGrid");
  const entities = allEntitiesForLinks();
  const options = () =>
    [`<option value="">‚Äî –≤—ã–±—Ä–∞—Ç—å ‚Äî</option>`].concat(
      entities.map(e=>`<option value="${esc(e.kind)}:${esc(e.id)}">${esc(e.label)}</option>`)
    ).join("");

  if(!state.links.length){
    grid.innerHTML = `<div class="card paper"><div class="hint">–ü–æ–∫–∞ –Ω–µ—Ç —Å–≤—è–∑–µ–π. –°–æ–∑–¥–∞–π –ø–µ—Ä–≤—É—é ‚Äî –∏ –º–∏—Ä –Ω–∞—á–Ω—ë—Ç ‚Äú–¥—ã—à–∞—Ç—å‚Äù.</div></div>`;
  }else{
    grid.innerHTML = state.links.map(l=>`
      <div class="card paper">
        <div class="row">
          <span class="pill">üîó –°–≤—è–∑—å</span>
          <div class="spacer"></div>
          <button class="btn danger small" data-dellink="${l.id}">üóë</button>
        </div>

        <label>–û—Ç–∫—É–¥–∞</label>
        <select data-link="${l.id}:from">${options()}</select>

        <label>–ö—É–¥–∞</label>
        <select data-link="${l.id}:to">${options()}</select>

        <label>–¢–∏–ø</label>
        <select data-link="${l.id}:type">
          <option value="ally">–°–æ—é–∑</option>
          <option value="enemy">–í—Ä–∞–∂–¥–∞</option>
          <option value="owes">–î–æ–ª–≥/–∫–ª—è—Ç–≤–∞</option>
          <option value="controls">–ö–æ–Ω—Ç—Ä–æ–ª—å/–≤–ª–∏—è–Ω–∏–µ</option>
          <option value="created">–°–æ–∑–¥–∞–ª/–ø–æ—Ä–æ–¥–∏–ª</option>
          <option value="secret">–¢–∞–π–Ω–∞—è —Å–≤—è–∑—å</option>
          <option value="other">–î—Ä—É–≥–æ–µ</option>
        </select>

        <label>–ö—Ä–∞—Ç–∫–æ</label>
        <input data-link="${l.id}:label" value="${esc(l.label||"")}" placeholder="–Ω–∞–ø—Ä.: ¬´–¥–µ—Ä–∂–∏—Ç –≤ –∑–∞–ª–æ–∂–Ω–∏–∫–∞—Ö¬ª">

        <label>–û–ø–∏—Å–∞–Ω–∏–µ</label>
        <textarea data-link="${l.id}:note">${esc(l.note||"")}</textarea>

        <label>üîÆ –¢–∞–π–Ω–æ–µ</label>
        <textarea data-link="${l.id}:secret">${esc(l.secret||"")}</textarea>

        <div class="small">–°–µ–π—á–∞—Å: <b>${esc(entityLabel(l.from))}</b> ‚Üí <b>${esc(entityLabel(l.to))}</b></div>
      </div>
    `).join("");
  }

  $$("[data-link]", grid).forEach(el=>{
    const [id, field] = el.dataset.link.split(":");
    const link = state.links.find(x=>x.id===id);
    if(!link) return;

    if(el.tagName==="SELECT" && (field==="from" || field==="to")){
      const v = link[field];
      el.value = v ? `${v.kind}:${v.id}` : "";
    }
    if(el.tagName==="SELECT" && field==="type") el.value = link.type || "other";

    el.oninput = ()=>{
      const [id2, field2] = el.dataset.link.split(":");
      const link2 = state.links.find(x=>x.id===id2);
      if(!link2) return;

      if(field2==="from" || field2==="to"){
        const raw = el.value || "";
        if(!raw) link2[field2] = null;
        else{
          const [k,i] = raw.split(":");
          link2[field2] = { kind:k, id:i };
        }
      }
      if(field2==="type") link2.type = el.value;
      if(field2==="label") link2.label = el.value;
      if(field2==="note") link2.note = el.value;
      if(field2==="secret") link2.secret = el.value;

      scheduleSave();
      renderLinks();
      renderSecrets();
    };
  });

  $$("[data-dellink]", grid).forEach(btn=>{
    btn.onclick = ()=>{
      if(!confirm("–£–¥–∞–ª–∏—Ç—å —Å–≤—è–∑—å?")) return;
      state.links = state.links.filter(x=>x.id!==btn.dataset.dellink);
      addJournal("link","–°–≤—è–∑—å —É–¥–∞–ª–µ–Ω–∞","–£–¥–∞–ª–µ–Ω–∞ —Å–≤—è–∑—å –º–µ–∂–¥—É —Å—É—â–Ω–æ—Å—Ç—è–º–∏.");
      scheduleSave();
      renderLinks();
      renderSecrets();
    };
  });

  if(!renderLinks._wired){
    $("#addLinkBtn").onclick = ()=>{
      state.links.unshift({ id: uid(), from:null, to:null, type:"other", label:"", note:"", secret:"" });
      addJournal("link","–°–æ–∑–¥–∞–Ω–∞ —Å–≤—è–∑—å","–î–æ–±–∞–≤–ª–µ–Ω–∞ –Ω–æ–≤–∞—è —Å–≤—è–∑—å.");
      scheduleSave();
      renderLinks();
    };
    renderLinks._wired = true;
  }
}

/* ===== Checkpoints ===== */
function renderCheckpoints(){
  const grid = $("#checkpointsGrid");
  if(!state.checkpoints.length){
    grid.innerHTML = `<div class="card paper"><div class="hint">–ü–æ–∫–∞ –Ω–µ—Ç —á–µ–∫–ø–æ–∏–Ω—Ç–æ–≤. –°–æ–∑–¥–∞–π –ø–µ—Ä–≤—ã–π ‚Äî —ç—Ç–æ —Ç–≤–æ—è —Å—Ç—Ä–∞—Ö–æ–≤–∫–∞.</div></div>`;
    return;
  }
  grid.innerHTML = state.checkpoints.map(cp=>`
    <div class="card paper">
      <div class="row">
        <span class="pill">‚úÖ ${esc(cp.title||"–ß–µ–∫–ø–æ–∏–Ω—Ç")}</span>
        <div class="spacer"></div>
        <span class="pill">${esc(prettyDate(cp.at))}</span>
      </div>
      <div class="hr"></div>
      <div class="small">${esc(cp.note||"").replaceAll("\n","<br>")}</div>
      <div class="hr"></div>
      <div class="row">
        <button class="btn ok small" data-restore="${cp.id}">‚è™ –û—Ç–∫–∞—Ç–∏—Ç—å—Å—è</button>
        <button class="btn ghost small" data-exportcp="${cp.id}">üíæ –≠–∫—Å–ø–æ—Ä—Ç</button>
        <button class="btn danger small" data-delcp="${cp.id}">üóë</button>
      </div>
    </div>
  `).join("");

  $$("[data-restore]", grid).forEach(b=>{
    b.onclick = ()=>{
      const id = b.dataset.restore;
      const cp = state.checkpoints.find(x=>x.id===id);
      if(!cp) return;
      if(!confirm("–û—Ç–∫–∞—Ç–∏—Ç—å—Å—è –∫ —ç—Ç–æ–º—É —á–µ–∫–ø–æ–∏–Ω—Ç—É? –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –±—É–¥–µ—Ç –∑–∞–º–µ–Ω–µ–Ω–æ.")) return;
      const keepTheme = localStorage.getItem("ether_theme") || "dark";
      state = migrateState(cp.snapshot);
      state.checkpoints = state.checkpoints; // keep snapshots inside snapshot anyway
      saveState();
      addJournal("checkpoint","–û—Ç–∫–∞—Ç –∫ —á–µ–∫–ø–æ–∏–Ω—Ç—É",`–û—Ç–∫–∞—Ç: ${cp.title}`);
      renderAll();
      applyTheme(keepTheme);
      openTab("checkpoints");
    };
  });
  $$("[data-delcp]", grid).forEach(b=>{
    b.onclick = ()=>{
      if(!confirm("–£–¥–∞–ª–∏—Ç—å —á–µ–∫–ø–æ–∏–Ω—Ç?")) return;
      const id = b.dataset.delcp;
      state.checkpoints = state.checkpoints.filter(x=>x.id!==id);
      addJournal("checkpoint","–ß–µ–∫–ø–æ–∏–Ω—Ç —É–¥–∞–ª—ë–Ω","–£–¥–∞–ª—ë–Ω —á–µ–∫–ø–æ–∏–Ω—Ç.");
      scheduleSave();
      renderCheckpoints();
      renderJournal();
    };
  });
  $$("[data-exportcp]", grid).forEach(b=>{
    b.onclick = ()=>{
      const id = b.dataset.exportcp;
      const cp = state.checkpoints.find(x=>x.id===id);
      if(!cp) return;
      const data = JSON.stringify(cp, null, 2);
      const blob = new Blob([data], {type:"application/json"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `ether_checkpoint_${(cp.title||"checkpoint").replaceAll(" ","_")}.json`;
      a.click();
      setTimeout(()=>URL.revokeObjectURL(url), 1200);
    };
  });
}

$("#createCheckpointBtn").onclick = ()=>{
  const title = ($("#cpTitle").value || "").trim() || "–ß–µ–∫–ø–æ–∏–Ω—Ç";
  const note = ($("#cpNote").value || "").trim();
  const cp = {
    id: uid(),
    at: nowIso(),
    title,
    note,
    snapshot: JSON.parse(JSON.stringify(state))
  };
  // don't snapshot checkpoints inside checkpoints infinitely? We'll keep it, but can prune old:
  cp.snapshot.checkpoints = []; // avoid growing snapshot size
  state.checkpoints.unshift(cp);
  $("#cpTitle").value = "";
  $("#cpNote").value = "";
  addJournal("checkpoint",`–ß–µ–∫–ø–æ–∏–Ω—Ç: ${title}`, note || "–°–Ω–∏–º–æ–∫ –º–∏—Ä–∞ —Å–æ—Ö—Ä–∞–Ω—ë–Ω.");
  scheduleSave();
  renderCheckpoints();
  renderJournal();
};

/* ===== Journal ===== */
function renderJournal(){
  const grid = $("#journalGrid");
  if(!state.journal.length){
    grid.innerHTML = `<div class="card paper"><div class="hint">–•—Ä–æ–Ω–∏–∫–∞ –ø—É—Å—Ç–∞. –ù–æ —ç—Ç–æ –Ω–µ–Ω–∞–¥–æ–ª–≥–æ.</div></div>`;
    return;
  }
  grid.innerHTML = state.journal.map(j=>`
    <div class="card paper">
      <div class="row">
        <span class="pill">üìú ${esc(j.title||"–ó–∞–ø–∏—Å—å")}</span>
        <div class="spacer"></div>
        <span class="pill">${esc(prettyDate(j.at))}</span>
        <button class="btn danger small" data-delj="${j.id}">üóë</button>
      </div>
      <div class="hr"></div>
      <div class="small">${esc(j.text||"").replaceAll("\n","<br>")}</div>
      <div class="hr"></div>
      <div class="small">–¢–∏–ø: <span class="mono">${esc(j.kind||"note")}</span></div>
    </div>
  `).join("");

  $$("[data-delj]", grid).forEach(b=>{
    b.onclick = ()=>{
      if(!confirm("–£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å —Ö—Ä–æ–Ω–∏–∫–∏?")) return;
      state.journal = state.journal.filter(x=>x.id!==b.dataset.delj);
      scheduleSave();
      renderJournal();
    };
  });
}

$("#addJournalBtn").onclick = ()=>{
  const title = prompt("–ó–∞–≥–æ–ª–æ–≤–æ–∫ –∑–∞–ø–∏—Å–∏:", "–ó–∞–ø–∏—Å—å") || "–ó–∞–ø–∏—Å—å";
  const text = prompt("–¢–µ–∫—Å—Ç –∑–∞–ø–∏—Å–∏:", "") || "";
  addJournal("manual", title, text);
  renderJournal();
};

/* ===== Secrets aggregation ===== */
function renderSecrets(){
  const out = [];

  const add = (title, where, secret)=>{
    const s = (secret||"").trim();
    if(!s) return;
    out.push(`
      <div class="card paper">
        <div class="row">
          <span class="pill">üîÆ ${esc(title)}</span>
          <div class="spacer"></div>
          <span class="pill">${esc(where)}</span>
        </div>
        <div class="hr"></div>
        <div class="hint">${esc(s).replaceAll("\n","<br>")}</div>
      </div>
    `);
  };

  state.events.forEach(x=>add(x.title, "–°–æ–±—ã—Ç–∏—è", x.secret));
  state.links.forEach(x=>add(x.label || "–°–≤—è–∑—å", "–°–≤—è–∑–∏", x.secret));
  state.map.markers.forEach(x=>add(x.title, "–ö–∞—Ä—Ç–∞: –æ—Ç–º–µ—Ç–∫–∏", x.secret));
  state.map.regions.forEach(x=>add(x.name, "–ö–∞—Ä—Ç–∞: —Ä–µ–≥–∏–æ–Ω—ã", x.secret));

  $("#secretsGrid").innerHTML = out.length ? out.join("") : `
    <div class="card paper">
      <div class="hint">–ü–æ–∫–∞ –Ω–µ—Ç —Ç–∞–π–Ω—ã—Ö –∑–∞–º–µ—Ç–æ–∫. –ó–∞–ø–æ–ª–Ω—è–π –ø–æ–ª–µ ¬´üîÆ –¢–∞–π–Ω–∞—è –∑–∞–º–µ—Ç–∫–∞¬ª –≤ –æ–±—ä–µ–∫—Ç–∞—Ö ‚Äî –∏ –æ–Ω–∏ –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å.</div>
    </div>
  `;
}

/* ===== Render all ===== */
function renderAll(){
  renderWorld();

  restoreMapImage();
  initMapUi();
  renderMap();
  renderSelectedEditor();
  renderMapLists();

  renderEras();
  renderFactions();
  renderEvents();
  renderLinks();

  renderCheckpoints();
  renderJournal();
  renderSecrets();

  saveState();
}

/* ===== Startup ===== */
openTab(state.ui.tab || "world");
renderAll();
</script>
</body>
</html>
